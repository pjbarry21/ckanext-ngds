L.AgsDynamicLayer=L.Class.extend({includes:L.Mixin.Events,options:{minZoom:0,maxZoom:18,attribution:"",opacity:1,layers:null,format:"PNG8",transparent:"true",defintionQuery:"",unloadInvisibleTiles:L.Browser.mobileWebkit},initialize:function(b,a){L.Util.setOptions(this,a);this._url=b},setLayers:function(a){this.options.layers=a;this._updateLayer()},getLayers:function(){return this.options.layers},setTransparent:function(a){this.options.transparent=a},getTransparent:function(){return this.options.transparent},setDefinitionQuery:function(a){this.options.defintionQuery=a},getDefinitionQuery:function(){return this.options.defintionQuery},setOpacity:function(a){if(this._image){this._image.style.opacity=a;this._image.style.webkitTransform+=" translate(0,0)"}this.options.opacity=a},getOpacity:function(){return this.options.opacity},reset:function(){this._reset()},update:function(){this._image.updating=false;this._updateLayer()},show:function(){this._image.style.display="block";this._image.style.visibility="visible"},hide:function(){this._image.style.display="none"},isVisible:function(){return this._image.style.display==="block"},onAdd:function(a){this._map=a;this._reset();a.on("viewreset",this._reset,this);a.on("moveend",this._moveEnd,this);a.on("zoomend",this._zoomEnd,this)},onRemove:function(a){a.getPanes().overlayPane.removeChild(this._image);a.off("viewreset",this._reset,this);a.off("moveend",this._moveEnd,this);a.off("zoomend",this._zoomEnd,this)},_initImage:function(){this._image=L.DomUtil.create("img","leaflet-image-layer");this._image.style.visibility="hidden";this._image.style.opacity=this.options.opacity;this._image.style.display="block";L.Util.extend(this._image,{onselectstart:L.Util.falseFn,onmousemove:L.Util.falseFn,onload:this._onImageLoad,src:this._getImageUrl(),updating:false,agsLayer:this,map:this._map});this._map.getPanes().overlayPane.appendChild(this._image)},img_map:{},_getImageUrl:function(){var i=this._map.getBounds();var f=this._map.getSize();var h="bbox="+i.getSouthEast().lng+","+i.getSouthEast().lat+","+i.getNorthWest().lng+","+i.getNorthWest().lat+"&bboxsr=4326&imageSR=3857";var b="&size="+f.x+","+f.y;var e="&format=png24";var g="&transparent="+this.options.transparent;var a=this._url+"/export?"+h+b+e+g+"&f=image";if(this.options.layers){var d="&layers="+this.options.layers;a+=d}this.img_map[ngds.Map.map.getZoom()]=a;return a},_updateLayer:function(){if(!this._image.updating){this._image.updating=true;this._image.src=this._getImageUrl();var d=this._map.latLngToLayerPoint(this._map.getBounds().getNorthWest()),b=this._map.latLngToLayerPoint(this._map.getBounds().getSouthEast()),a=b.subtract(d);L.DomUtil.setPosition(this._image,d);this._image.style.width=a.x+"px";this._image.style.height=a.y+"px";this._image.style.zIndex=-1}},_moveEnd:function(){if(ngds.Map.map.getZoom()<=3){return}this._image.style.display="none";this._updateLayer()},_zoomEnd:function(){if(ngds.Map.map.getZoom()<=3){return}this._image.style.display="none";this._updateLayer()},_reset:function(){if(ngds.Map.map.getZoom()<=3){return}if(this._image){c=this._map.getPanes().overlayPane;if(this._map.getPanes().overlayPane.hasChildNodes()){try{this._map.getPanes().overlayPane.removeChild(this._image)}catch(a){}}}this._initImage();this._updateLayer()},_onImageLoad:function(){this.style.visibility="visible";this.style.display="block";this.updating=false}});