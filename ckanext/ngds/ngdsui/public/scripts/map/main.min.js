/*
 *	@author - Vivek Sunder
 *	This is the top-level control module for the NGDS map.
 */ngds.config={number_of_rows:10};typeof ngds.Search!="undefined";ngds.feature_event_manager={};ngds.layer_map={};(function(){ngds.subscribe("Map.loaded",function(e,t){})})();if(typeof ngds.Map!="undefined"){$(document).ready(function(){ngds.Map.initialize()});ngds.Map.top_level_search=function(){ngds.publish("Map.expander.toggle",{});ngds.pager=new ngds.Search;ngds.publish("Map.search_initiated",{});var e=ngds.Map.get_layer("drawnItems"),t=$("#map-query").val();ngds.util.clear_map_state();ngds.pager.go_to({page:1,action:ngds.ckanlib.package_search,rows:ngds.config.number_of_rows,q:t})}}(function(){$("#map-search").click(function(){ngds.Map.top_level_search()});$(".search-results-page-nums").on("click",null,function(e){var t=e.target.firstChild.data;t==="<"&&(t=Number(ngds.Map.cur_page)-1);t===">"&&(t=Number(ngds.Map.cur_page)+1);t===0&&(t=1);t>=ngds.Map.num_pages&&(t=ngds.Map.num_pages);if(typeof t=="undefined")return;ngds.log("Going to page : "+t);ngds.publish("page.advance",{page:t})})})();(function(){ngds.subscribe("page.advance",function(e,t){ngds.feature_ngds_id_mapping={};ngds.util.clear_map_state();ngds.Map.zoom_handler.clear_listeners();ngds.pager.go_to({page:t.page,action:ngds.ckanlib.package_search,rows:10})})})();(function(){ngds.subscribe("data-loading",function(e,t){ngds.publish("Map.results_hide",{});ngds.Map.map.fireEvent("dataloading")})})();(function(){ngds.subscribe("data-loaded",function(e,t){ngds.Map.map.fireEvent("dataload")})})();typeof ngds.Map!="undefined"&&$(document).ready(function(){ngds.Map.map.on("draw:rectangle-created",function(e){ngds.Map.clear_layer("drawnItems");ngds.Map.add_to_layer([e.rect],"drawnItems");ngds.publish("Map.area_selected",{type:"rectangle",feature:e})});ngds.Map.map.on("draw:poly-created",function(e){ngds.Map.clear_layer("drawnItems");ngds.Map.add_to_layer([e.poly],"drawnItems");ngds.publish("Map.area_selected",{type:"polygon",feature:e})})});(function(){ngds.subscribe("Map.feature_received",function(e,t){var n=ngds.Map.add_raw_result_to_geojson_layer(t.feature,{seq:t.seq,alph_seq:t.alph_seq});ngds.publish("Map.feature_processed",{feature:n,seq:t.seq})});$(".map-search-results").on("mouseover",null,function(e){var t="";typeof e.srcElement=="undefined"?t=e.target:t=e.srcElement;var n=ngds.util.node_matcher(t,/result-\d.*/);if(n===null)return;var r={layer:ngds.layer_map[n]};ngds.publish("Layer.mouseover",{Layer:r,tag_index:n})});$(".map-search-results").on("mouseout",null,function(e){var t="";typeof e.srcElement=="undefined"?t=e.target:t=e.srcElement;var n=ngds.util.node_matcher(t,/result-\d.*/);if(n===null)return;var r={layer:ngds.layer_map[n]};ngds.publish("Layer.mouseout",{Layer:r,tag_index:n})});$(".map-search-results").on("click",".result",function(e){console.log($(this).attr("class"));var t="";console.log("here");typeof e.srcElement=="undefined"?t=e.target:t=e.srcElement;var n=ngds.util.node_matcher(t,/result-\d.*/);if(n===null||typeof n=="undefined")return;ngds.util.reset_result_styles();var r={layer:ngds.layer_map[n]};ngds.publish("Layer.click",{Layer:r,tag_index:n})});$(".map-search-results").on("click",".visibility-toggler button",function(e){e.stopPropagation();var t=Number($(e.target).attr("data-seq"));ngds.Map.visibility_mgr.process(t)});ngds.Map.visibility_mgr={init:function(){var e=this;ngds.subscribe("Map.feature_processed",function(t,n){var r=function(e){ngds.Map.map.addLayer(e)},i=function(e){ngds.Map.map.removeLayer(e)};e.features[n.seq]=e.construct_individual_mgr(n.feature,n.seq,r,i)});var t=function(t){for(var n in e.features)Number(n)!==0&&e.features[n].show();$("button[data-seq='0']").removeClass("toggled")},n=function(t){for(var n in e.features)Number(n)!==0&&e.features[n].hide();$("button[data-seq='0']").addClass("toggled")},r=e.construct_individual_mgr(null,0,t,n);e.features[0]=r},process:function(e){var t=this;t.features[e].is_hidden()?t.features[e].show():t.features[e].hide()},clearMgrs:function(){var e=this.features[0];this.features=[e]},features:{},construct_individual_mgr:function(e,t,n,r){var i=$("button[data-seq="+t+"]"),e=e,s=!1,o={show:function(){n(e);i.removeClass("toggled");s=!1},hide:function(){r(e);i.addClass("toggled");s=!0},is_hidden:function(){return s}};return o}};ngds.Map.visibility_mgr.init()})();(function(){ngds.subscribe("Layer.mouseover",function(e,t){if(typeof t.Layer=="undefined"||typeof t.Layer.layer=="undefined")return;var n=t.Layer.layer.is_active||null;(n===null||n===!1)&&ngds.util.apply_feature_hover_styles(t.Layer.layer,t.tag_index)});ngds.subscribe("Layer.mouseout",function(e,t){if(typeof t.Layer=="undefined"||typeof t.Layer.layer=="undefined")return;var n=t.Layer.layer.is_active||null;(n===null||n===!1)&&ngds.util.apply_feature_default_styles(t.Layer.layer,t.tag_index)});ngds.subscribe("Layer.click",function(e,t){if(typeof t.Layer=="undefined"||typeof t.Layer.layer=="undefined")return;ngds.util.reset_result_styles();for(var n in ngds.layer_map){ngds.util.apply_feature_default_styles(ngds.layer_map[n],n);ngds.layer_map[n]._leaflet_id===t.Layer.layer._leaflet_id?ngds.layer_map[n].is_active=!0:ngds.layer_map[n].is_active=!1}var r=t.Layer.layer._latlng||t.Layer.layer._latlngs,i=function(e){if(typeof e=="object"&&typeof e[0]=="undefined")return e;var t=ngds.Map.utils.get_bound(e,"lat","min"),n=ngds.Map.utils.get_bound(e,"lat","max"),r=ngds.Map.utils.get_bound(e,"lng","min"),i=ngds.Map.utils.get_bound(e,"lng","max");return{lat:(t+n)/2,lng:(r+i)/2}}(r);ngds.Map.map.panTo(i);try{t.Layer.layer.openPopup()}catch(s){}ngds.util.apply_feature_active_styles(t.Layer,t.tag_index)});ngds.subscribe("Layer.add",function(e,t){});ngds.subscribe("Layer.remove",function(e,t){})})();(function(){ngds.subscribe("Map.add_feature",function(e,t){var n=t.feature;ngds.layer_map[t.seq_id]=n;ngds.util.apply_feature_default_styles(n,t.seq_id);ngds.feature_event_manager[n._leaflet_id]={Layer:n,seq_id:t.seq_id};ngds.publish("Map.layer_added",{});n.on("mouseover",function(e){ngds.publish("Layer.mouseover",{Layer:e,tag_index:t.seq_id})});n.on("mouseout",function(e){ngds.publish("Layer.mouseout",{Layer:e,tag_index:t.seq_id})});n.on("click",function(e){ngds.publish("Layer.click",{Layer:e,tag_index:t.seq_id})})})})();ngds.subscribe("Map.results_rendered",function(e,t){var n=ngds.util.state.map_features.map(function(e){var t=e.getBounds(),n=t.getSouthWest(),r=t.getNorthEast();return new L.LatLngBounds(n,r)});for(var r=0;r<n.length;r++)n[r].extend(n[r-1]);ngds.Map.map.fitBounds(n[n.length-1]);$(".visibility-managed").show();$(".results").jScrollPane({contentWidth:"0px",hideFocus:!0})});ngds.subscribe("Map.results_hide",function(e,t){$(".visibility-managed").hide()});$(document).ready(function(){var e=!1;$(".map-expander").on("click",function(){if(e===!1){$(".visibility-managed").hide();e=!0}else{$(".visibility-managed").show();e=!1}})});(function(){ngds.subscribe("Map.size_changed",function(e,t){if(t.fullscreen===!0){ngds.Map.state["map-search-results-left"]=$(".map-search-results").css("left");ngds.Map.state["map-search-results-top"]=$(".map-search-results").css("top");ngds.Map.state["map-search-left"]=$(".map-search").css("left");ngds.Map.state["map-search-top"]=$(".map-search").css("top");$(".map-search").css({left:"10px",position:"fixed"});$(".map-search-results").css({left:"10px",position:"fixed"})}else{$(".map-search").css({left:ngds.Map.state["map-search-left"],top:ngds.Map.state["map-search-top"],position:"absolute"});$(".map-search-results").css({left:ngds.Map.state["map-search-results-left"],top:ngds.Map.state["map-search-results-top"],position:"absolute"})}})})();$(document).ready(function(){ngds.Map.map.on("zoomend",ngds.util.make_prominent);$(".map-search").on("click",".wms",function(e){e.preventDefault();ckan.notify("Please wait while the Web Map Services you requested are fetched","","info");var t=$(this).attr("data-package-id");ngds.ckanlib.get_wms_urls(t,function(e){for(var t=0;t<e.length;t++){var n=e[t],r={layers:n.layer,format:"image/png",transparent:!0,attribution:"NGDS",tileSize:128,opacity:.9999,version:"1.1.1"},i=L.tileLayer.wms(n.url,r);ngds.Map.layer_control.addOverlay(i,n.layer);ngds.Map.map.addLayer(i)}ckan.notify("The Web Map Services you requested have been added to the map.","","success")});return!1})});ngds.subscribe("Map.layer_added",function(){ngds.util.make_prominent()});