<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>transaction_tables.py</title>
  <link rel="stylesheet" href="../../../../pycco.css">
</head>
<body>
<div id="background"></div>
<div id='container'>
  <div class='section'>
    <div class='docs'><h1>transaction_tables.py</h1></div>
  </div>
  <div class='clearall'>
  <div class='section' id='section-0'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-0'>#</a>
      </div>
      <p>Contains models for the transaction tables used part of ngds.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="kn">from</span> <span class="nn">ckan</span> <span class="kn">import</span> <span class="n">model</span>


<span class="kn">from</span> <span class="nn">ckan.model</span> <span class="kn">import</span> <span class="n">meta</span>

<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">types</span><span class="p">,</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Table</span><span class="p">,</span> <span class="n">ForeignKey</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">relationship</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.sql</span> <span class="kn">import</span> <span class="n">func</span>

<span class="kn">import</span> <span class="nn">datetime</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">ckanext.ngds.base.model.ngds_db_object</span> <span class="kn">import</span> <span class="n">NgdsDataObject</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-1'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-1'>#</a>
      </div>
      <p>A BulkUpload represents the details of a bulk uploaded dataset and status of the processing.
<em>data_file - xls file path which contains the details about dataset, resource.
</em>resources - zip file path which contains the documents/resources to be uploaded as part of dataset creation which
            is linked in the xls file.
<em>path - Full path of the location where data_file and resources are stored.
</em>status - Status of a particular record (VALID,INVALID, COMPLETED, FAILURE)
<em>comments - Contains the reason for failure or validaiton error messages.
</em>uploaded_by - User who uploaded this record.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">BulkUpload</span><span class="p">(</span><span class="n">NgdsDataObject</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-2'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-2'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-3'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-3'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_file</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;data_file&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resources</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;resources&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;path&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;status&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comments</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;comments&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uploaded_by</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;uploaded_by&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-4'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-4'>#</a>
      </div>
      <p>Search by status</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">search</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">querystr</span><span class="p">,</span> <span class="n">sqlalchemy_query</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-5'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-5'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="n">sqlalchemy_query</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">sqlalchemy_query</span>

        <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">querystr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">query</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-6'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-6'>#</a>
      </div>
      <p>Returns a bulk upload record referenced by its id or name.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_all</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
         <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">uploaded_date</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">by_data_file</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">querystr</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-7'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-7'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">query</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">data_file</span> <span class="o">==</span> <span class="n">querystr</span><span class="p">)</span>
        <span class="n">member</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>        
        <span class="k">return</span> <span class="n">member</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-8'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-8'>#</a>
      </div>
      <p>Returns a bulk upload record referenced by its id or name.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">reference</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-9'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-9'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">query</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">reference</span><span class="p">)</span>
        <span class="n">member</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">member</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">member</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">by_data_file</span><span class="p">(</span><span class="n">reference</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">member</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-10'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-10'>#</a>
      </div>
      <p>A BulkUpload_Package represents the packages created as part of the bulk upload process.
<em>package_name - unique name of package
</em>package_title - Short description about the package</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">BulkUpload_Package</span><span class="p">(</span><span class="n">NgdsDataObject</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-11'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-11'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-12'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-12'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bulk_upload_id</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;bulk_upload_id&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">package_name</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;package_name&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">package_title</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;package_title&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uploaded_date</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;uploaded_date&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-13'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-13'>#</a>
      </div>
      <p>This method returns data based on input bulk upload identifier.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">by_bulk_upload</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">querystr</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-14'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-14'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">query</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">bulk_upload_id</span> <span class="o">==</span> <span class="n">querystr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-15'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-15'>#</a>
      </div>
      <p>A StandingData represents the all the lookup values used in the system. Any restricted list of data is represented
in this table.
 <em>description - Explains about the lookup value (typically what is displayed to user)
 </em>code - Any other code available to represent the lookup data
 *data_type - type of lookup data. (E.g. status (Dataset status), protocol (Protocol of the resource)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">StandingData</span><span class="p">(</span><span class="n">NgdsDataObject</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-16'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-16'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;description&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;code&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_type</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;data_type&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-17'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-17'>#</a>
      </div>
      <p>This method validates whether given SD value is present in the model or not.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">data_type</span><span class="p">,</span> <span class="n">sdvalue</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-18'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-18'>#</a>
      </div>
      <p>f exists returns SD description otherwise None """</p>
<p>rint "Data type:%s SD Value: %s" % (data_type, sdvalue)</p>
<p>uery = meta.Session.query(cls).filter(cls.data_type == data_type)
uery = query.filter(func.lower(cls.description) == sdvalue.lower())
ember = query.first()      <br />
f member is None:
   return None
lse:
   if member.code is not None:
       return member.code
   else: 
       return member.description</p>
<p>rSearch(NgdsDataObject):</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">UserSearch</span> <span class="n">represents</span> <span class="n">the</span> <span class="n">saved</span> <span class="n">searches</span> <span class="n">of</span> <span class="n">registered</span> <span class="n">users</span><span class="o">.</span>
    <span class="o">*</span><span class="n">user_id</span> <span class="o">-</span> <span class="n">Saved</span> <span class="n">user</span> <span class="n">identifier</span>
    <span class="o">*</span><span class="n">search_name</span> <span class="o">-</span> <span class="n">Name</span> <span class="k">for</span> <span class="n">the</span> <span class="n">saved</span> <span class="n">search</span><span class="o">.</span>
    <span class="o">*</span><span class="n">url</span> <span class="o">-</span> <span class="n">Actual</span> <span class="n">saved</span> <span class="n">search</span> <span class="n">URL</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-19'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-19'>#</a>
      </div>
      <p>def <strong>init</strong>(self, **kwargs):
    self.user_id = kwargs.get('user_id', None)
    self.search_name = kwargs.get('search_name', None)
    self.url = kwargs.get('url', None)</p>
<p>@classmethod
def search(cls, user_id, sqlalchemy_query=None):</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">This</span> <span class="n">method</span> <span class="n">searches</span> <span class="n">the</span> <span class="n">saved</span> <span class="n">searches</span> <span class="n">by</span> <span class="n">a</span> <span class="n">registered</span> <span class="n">user</span><span class="o">.</span> <span class="n">If</span> <span class="n">the</span> <span class="n">query</span> <span class="ow">is</span> <span class="n">provided</span> <span class="k">as</span> <span class="nb">input</span> <span class="n">then</span> <span class="n">that</span> <span class="ow">is</span>
        <span class="n">used</span> <span class="k">for</span> <span class="n">constructing</span> <span class="n">the</span> <span class="n">query</span> <span class="n">otherwise</span> <span class="n">default</span> <span class="n">selection</span> <span class="ow">is</span> <span class="n">used</span><span class="o">.</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-20'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-20'>#</a>
      </div>
      <p>if sqlalchemy_query is None:
    query = meta.Session.query(cls)
else:
    query = sqlalchemy_query
query = query.filter(cls.user_id == user_id)
return query</p>
<p>cumentIndex(NgdsDataObject):</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">DocumentIndex</span> <span class="n">model</span> <span class="n">represents</span> <span class="n">the</span> <span class="n">physical</span> <span class="n">documents</span> <span class="n">uploaded</span> <span class="k">as</span> <span class="n">part</span> <span class="n">of</span> <span class="n">resource</span> <span class="n">which</span> <span class="n">needs</span> <span class="n">to</span> <span class="n">be</span> <span class="n">full</span><span class="o">-</span><span class="n">text</span> <span class="n">indexed</span><span class="o">.</span>
    <span class="o">*</span><span class="n">file_path</span> <span class="o">-</span> <span class="n">Full</span> <span class="n">path</span> <span class="n">of</span> <span class="n">the</span> <span class="n">uploaded</span> <span class="n">document</span>
    <span class="o">*</span><span class="n">status</span> <span class="o">-</span> <span class="n">explains</span> <span class="n">the</span> <span class="n">status</span> <span class="n">of</span> <span class="n">current</span> <span class="n">document</span> <span class="p">(</span><span class="n">NEW</span><span class="p">,</span><span class="n">CANCEL</span><span class="p">,</span><span class="n">COMPLETED</span><span class="p">)</span>
    <span class="o">*</span><span class="n">comments</span> <span class="o">-</span> <span class="n">Any</span> <span class="n">exception</span> <span class="n">comments</span> <span class="k">if</span> <span class="n">there</span> <span class="ow">is</span> <span class="n">an</span> <span class="n">error</span><span class="o">.</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-21'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-21'>#</a>
      </div>
      <p>def <strong>init</strong>(self, **kwargs):
    self.package_id = kwargs.get('package_id', None)
    self.resource_id = kwargs.get('resource_id', None)
    self.file_path = kwargs.get('file_path', None)
    self.status = kwargs.get('status', None)
    self.comments = kwargs.get('comments', None)</p>
<p>@classmethod
def search(cls, status, sqlalchemy_query=None):</p>
<pre><code>if sqlalchemy_query is None:
    query = meta.Session.query(cls)
else:
    query = sqlalchemy_query
query = query.filter(cls.status == status)
return query
</code></pre>
<p>define_tables():
Create the in-memory represenatation of tables, and map those tables to classes defined above</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-22'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-22'>#</a>
      </div>
      <p>First define the tables</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">bulkupload</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
        <span class="s">&quot;bulk_upload&quot;</span><span class="p">,</span>
        <span class="n">meta</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
        <span class="n">Column</span><span class="p">(</span><span class="s">&quot;id&quot;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
        <span class="n">Column</span><span class="p">(</span><span class="s">&quot;data_file&quot;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">UnicodeText</span><span class="p">),</span>
        <span class="n">Column</span><span class="p">(</span><span class="s">&quot;resources&quot;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">UnicodeText</span><span class="p">),</span>
        <span class="n">Column</span><span class="p">(</span><span class="s">&quot;path&quot;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">UnicodeText</span><span class="p">),</span>
        <span class="n">Column</span><span class="p">(</span><span class="s">&quot;status&quot;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">UnicodeText</span><span class="p">),</span>
        <span class="n">Column</span><span class="p">(</span><span class="s">&quot;comments&quot;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">UnicodeText</span><span class="p">),</span>
        <span class="n">Column</span><span class="p">(</span><span class="s">&quot;uploaded_by&quot;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">UnicodeText</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s">&quot;user.id&quot;</span><span class="p">)),</span>
        <span class="n">Column</span><span class="p">(</span><span class="s">&quot;uploaded_date&quot;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">),</span>
        <span class="n">Column</span><span class="p">(</span><span class="s">&#39;last_updated&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">bulkupload_package</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
        <span class="s">&quot;bulk_upload_package&quot;</span><span class="p">,</span>
        <span class="n">meta</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
        <span class="n">Column</span><span class="p">(</span><span class="s">&quot;id&quot;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
        <span class="n">Column</span><span class="p">(</span><span class="s">&quot;bulk_upload_id&quot;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s">&quot;bulk_upload.id&quot;</span><span class="p">)),</span>
        <span class="n">Column</span><span class="p">(</span><span class="s">&quot;package_name&quot;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">UnicodeText</span><span class="p">),</span>
        <span class="n">Column</span><span class="p">(</span><span class="s">&quot;package_title&quot;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">UnicodeText</span><span class="p">),</span>
        <span class="n">Column</span><span class="p">(</span><span class="s">&quot;uploaded_date&quot;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">),</span>
    <span class="p">)</span>    

    <span class="n">standingdata</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
        <span class="s">&quot;standing_data&quot;</span><span class="p">,</span>
        <span class="n">meta</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
        <span class="n">Column</span><span class="p">(</span><span class="s">&quot;id&quot;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
        <span class="n">Column</span><span class="p">(</span><span class="s">&quot;code&quot;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">UnicodeText</span><span class="p">),</span>
        <span class="n">Column</span><span class="p">(</span><span class="s">&quot;description&quot;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">UnicodeText</span><span class="p">),</span>
        <span class="n">Column</span><span class="p">(</span><span class="s">&quot;data_type&quot;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">UnicodeText</span><span class="p">),</span>
    <span class="p">)</span>    

    <span class="n">user_saved_search</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
        <span class="s">&quot;user_saved_search&quot;</span><span class="p">,</span>
        <span class="n">meta</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
        <span class="n">Column</span><span class="p">(</span><span class="s">&quot;id&quot;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
        <span class="n">Column</span><span class="p">(</span><span class="s">&quot;user_id&quot;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">UnicodeText</span><span class="p">),</span>
        <span class="n">Column</span><span class="p">(</span><span class="s">&quot;search_name&quot;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">UnicodeText</span><span class="p">),</span>
        <span class="n">Column</span><span class="p">(</span><span class="s">&quot;url&quot;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">UnicodeText</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">document_index</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
        <span class="s">&quot;resource_document_index&quot;</span><span class="p">,</span>
        <span class="n">meta</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
        <span class="n">Column</span><span class="p">(</span><span class="s">&quot;id&quot;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
        <span class="n">Column</span><span class="p">(</span><span class="s">&quot;package_id&quot;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">UnicodeText</span><span class="p">),</span>
        <span class="n">Column</span><span class="p">(</span><span class="s">&quot;resource_id&quot;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">UnicodeText</span><span class="p">),</span>
        <span class="n">Column</span><span class="p">(</span><span class="s">&quot;file_path&quot;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">UnicodeText</span><span class="p">),</span>
        <span class="n">Column</span><span class="p">(</span><span class="s">&quot;status&quot;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">UnicodeText</span><span class="p">),</span>
        <span class="n">Column</span><span class="p">(</span><span class="s">&quot;comments&quot;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">UnicodeText</span><span class="p">),</span>
        <span class="n">Column</span><span class="p">(</span><span class="s">&#39;last_updated&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">),</span>
    <span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-23'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-23'>#</a>
      </div>
      <p>Map those tables to classes, define the additional properties for related models</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">meta</span><span class="o">.</span><span class="n">mapper</span><span class="p">(</span><span class="n">BulkUpload</span><span class="p">,</span> <span class="n">bulkupload</span><span class="p">,</span>
        <span class="n">properties</span><span class="o">=</span><span class="p">{</span>
            <span class="s">&quot;uploaded_user&quot;</span><span class="p">:</span> <span class="n">relationship</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">User</span><span class="p">)</span>            
        <span class="p">}</span>
    <span class="p">)</span>
    <span class="n">meta</span><span class="o">.</span><span class="n">mapper</span><span class="p">(</span><span class="n">StandingData</span><span class="p">,</span> <span class="n">standingdata</span><span class="p">)</span>
    <span class="n">meta</span><span class="o">.</span><span class="n">mapper</span><span class="p">(</span><span class="n">BulkUpload_Package</span><span class="p">,</span> <span class="n">bulkupload_package</span><span class="p">)</span>
    <span class="n">meta</span><span class="o">.</span><span class="n">mapper</span><span class="p">(</span><span class="n">UserSearch</span><span class="p">,</span> <span class="n">user_saved_search</span><span class="p">)</span>
    <span class="n">meta</span><span class="o">.</span><span class="n">mapper</span><span class="p">(</span><span class="n">DocumentIndex</span><span class="p">,</span> <span class="n">document_index</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-24'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-24'>#</a>
      </div>
      <p>Stick these classes into the CKAN.model, for ease of access later</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">model</span><span class="o">.</span><span class="n">BulkUpload</span> <span class="o">=</span> <span class="n">BulkUpload</span>
    <span class="n">model</span><span class="o">.</span><span class="n">StandingData</span> <span class="o">=</span> <span class="n">StandingData</span>
    <span class="n">model</span><span class="o">.</span><span class="n">BulkUpload_Package</span> <span class="o">=</span> <span class="n">BulkUpload_Package</span>
    <span class="n">model</span><span class="o">.</span><span class="n">UserSearch</span> <span class="o">=</span> <span class="n">UserSearch</span>
    <span class="n">model</span><span class="o">.</span><span class="n">DocumentIndex</span> <span class="o">=</span> <span class="n">DocumentIndex</span>
    
    <span class="k">return</span> <span class="n">bulkupload</span><span class="p">,</span> <span class="n">bulkupload_package</span><span class="p">,</span> <span class="n">standingdata</span><span class="p">,</span> <span class="n">user_saved_search</span><span class="p">,</span> <span class="n">document_index</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-25'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-25'>#</a>
      </div>
      <p>Create tables in the database</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">db_setup</span><span class="p">():</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-26'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-26'>#</a>
      </div>
      <p>These tables will already be defined in memory IConfigurer will make a call to define_tables()</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    
    <span class="n">bulkupload</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;bulk_upload&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="n">bulkupload_package</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;bulk_upload_package&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="n">standingdata</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;standing_data&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="n">user_saved_search</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;user_saved_search&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="n">document_index</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;resource_document_index&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">bulkupload</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-27'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-27'>#</a>
      </div>
      <p>The tables have not been defined. Its likely that the plugin is not enabled in the CKAN .ini file</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Could not create additional tables. Please make sure that you&#39;ve added the metadata plugin to your CKAN config .ini file.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>    
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Additional Metadata tables defined in memory&#39;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-28'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-28'>#</a>
      </div>
      <p>Alright. Create the tables.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="kn">from</span> <span class="nn">ckanext.ngds.base.commands.ngds_tables</span> <span class="kn">import</span> <span class="n">create_tables</span>
        <span class="n">create_tables</span><span class="p">([</span><span class="n">bulkupload</span><span class="p">,</span><span class="n">bulkupload_package</span><span class="p">,</span><span class="n">standingdata</span><span class="p">,</span><span class="n">user_saved_search</span><span class="p">,</span><span class="n">document_index</span><span class="p">],</span> <span class="n">log</span><span class="p">)</span>

</pre></div>
    </div>
  </div>
  <div class='clearall'></div>
</div>
</body>
