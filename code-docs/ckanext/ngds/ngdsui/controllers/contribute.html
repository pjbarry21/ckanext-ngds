<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>contribute.py</title>
  <link rel="stylesheet" href="../../../../pycco.css">
</head>
<body>
<div id="background"></div>
<div id='container'>
  <div class='section'>
    <div class='docs'><h1>contribute.py</h1></div>
  </div>
  <div class='clearall'>
  <div class='section' id='section-0'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-0'>#</a>
      </div>
      <p>This controller class is responsible at a high level for managing the dataset and resource contribution workflow. This includes rendering of the dataset and resource contribution forms,
rendering of the bulk upload page and dataset and resource validation.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">zipfile</span>

<span class="kn">from</span> <span class="nn">pylons</span> <span class="kn">import</span> <span class="n">config</span>
<span class="kn">from</span> <span class="nn">pylons.decorators</span> <span class="kn">import</span> <span class="n">jsonify</span>

<span class="kn">from</span> <span class="nn">ckan.lib.base</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">ckan.lib.navl.dictization_functions</span> <span class="kn">import</span> <span class="n">unflatten</span>
<span class="kn">from</span> <span class="nn">ckan.lib.base</span> <span class="kn">import</span> <span class="p">(</span><span class="n">request</span><span class="p">,</span>
                           <span class="n">render</span><span class="p">,</span>
                           <span class="n">model</span><span class="p">,</span>
                           <span class="n">abort</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">ckan.logic</span> <span class="kn">import</span> <span class="p">(</span><span class="n">tuplize_dict</span><span class="p">,</span> <span class="n">clean_dict</span><span class="p">,</span> <span class="n">parse_params</span><span class="p">,</span> <span class="n">get_action</span><span class="p">,</span> <span class="n">check_access</span><span class="p">,</span> <span class="n">NotAuthorized</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">ckanext.ngds.ngdsui.controllers.ngds</span> <span class="kn">import</span> <span class="n">NGDSBaseController</span>
<span class="kn">import</span> <span class="nn">ckanext.ngds.importer.helper</span> <span class="kn">as</span> <span class="nn">import_helper</span>
<span class="kn">from</span> <span class="nn">ckan.controllers.package</span> <span class="kn">import</span> <span class="n">PackageController</span>
<span class="kn">from</span> <span class="nn">ckan.plugins</span> <span class="kn">import</span> <span class="n">toolkit</span>
<span class="kn">import</span> <span class="nn">ckanext.ngds.lib.importer.validator</span> <span class="kn">as</span> <span class="nn">ngdsvalidator</span>
<span class="kn">from</span> <span class="nn">ckanext.ngds.ngdsui.misc.helpers</span> <span class="kn">import</span> <span class="n">process_resource_docs_to_index</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-1'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-1'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">ContributeController</span><span class="p">(</span><span class="n">NGDSBaseController</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-2'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-2'>#</a>
      </div>
      <p>This function renders the contribute landing page for a node-in-a-box and the harvest page for the central node.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-3'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-3'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
            <span class="n">h</span><span class="o">.</span><span class="n">redirect_to</span><span class="p">(</span><span class="n">controller</span><span class="o">=</span><span class="s">&#39;user&#39;</span><span class="p">,</span>
                              <span class="n">action</span><span class="o">=</span><span class="s">&#39;login&#39;</span><span class="p">,</span> <span class="n">came_from</span><span class="o">=</span><span class="n">h</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span><span class="n">controller</span><span class="o">=</span><span class="s">&#39;ckanext.ngds.ngdsui.controllers.contribute:ContributeController&#39;</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s">&#39;index&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">central</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-4'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-4'>#</a>
      </div>
      <p>TODO: Need to change this to point the correct controller</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">url</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">url_for_static</span><span class="p">(</span><span class="n">controller</span><span class="o">=</span><span class="s">&#39;ckanext.harvest.controllers.view:ViewController&#39;</span><span class="p">)</span>
            <span class="n">h</span><span class="o">.</span><span class="n">redirect_to</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="s">&#39;contribute/contribute.html&#39;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-5'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-5'>#</a>
      </div>
      <p>This function renders the harvest source addition page.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">harvest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-6'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-6'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">c</span><span class="o">.</span><span class="n">action</span> <span class="o">=</span> <span class="s">&#39;save&#39;</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="s">&#39;contribute/harvest_new.html&#39;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-7'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-7'>#</a>
      </div>
      <p>This function renders the bulk upload form.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">bulk_upload</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-8'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-8'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;model&#39;</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span> <span class="s">&#39;session&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">Session</span><span class="p">,</span> <span class="s">&#39;user&#39;</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">user</span> <span class="ow">or</span> <span class="n">c</span><span class="o">.</span><span class="n">author</span><span class="p">}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">check_access</span><span class="p">(</span><span class="s">&#39;package_create&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">NotAuthorized</span><span class="p">,</span> <span class="n">error</span><span class="p">:</span>
            <span class="n">abort</span><span class="p">(</span><span class="mi">401</span><span class="p">,</span> <span class="n">error</span><span class="o">.</span><span class="n">__str__</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="s">&#39;contribute/bulkupload_form.html&#39;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-9'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-9'>#</a>
      </div>
      <p>function is responsible for receiving a dataset excel file and a zip file from the bulk upload form, validating and initiating processing of the bulk upload.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">bulk_upload_handle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-10'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-10'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;model&#39;</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span> <span class="s">&#39;session&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">Session</span><span class="p">,</span> <span class="s">&#39;user&#39;</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">user</span> <span class="ow">or</span> <span class="n">c</span><span class="o">.</span><span class="n">author</span><span class="p">}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">check_access</span><span class="p">(</span><span class="s">&#39;package_create&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">NotAuthorized</span><span class="p">,</span> <span class="n">error</span><span class="p">:</span>
            <span class="n">abort</span><span class="p">(</span><span class="mi">401</span><span class="p">,</span> <span class="n">error</span><span class="o">.</span><span class="n">__str__</span><span class="p">())</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-11'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-11'>#</a>
      </div>
      <p>Validate the dataset file.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">bulk_dir</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;ngds.bulk_upload_dir&#39;</span><span class="p">)</span>

        <span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

        <span class="n">ts</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">upload_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bulk_dir</span><span class="p">,</span> <span class="n">ts</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">upload_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">upload_dir</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-12'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-12'>#</a>
      </div>
      <p>Recieve the dataset file to be processed.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">datasetfile</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">&#39;datasetfile&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">datasetfile</span> <span class="o">==</span> <span class="s">&quot;&quot;</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-13'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-13'>#</a>
      </div>
      <p>raise Exception (_("Data file can't be empty."))</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">abort</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="n">toolkit</span><span class="o">.</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Data file can&#39;t be empty.&quot;</span><span class="p">))</span>

        <span class="n">datafilename</span> <span class="o">=</span> <span class="n">datasetfile</span><span class="o">.</span><span class="n">filename</span>

        <span class="n">datafilepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">upload_dir</span><span class="p">,</span> <span class="n">datasetfile</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">,</span> <span class="s">&#39;_&#39;</span><span class="p">))</span>

        <span class="n">permanent_data_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">datafilepath</span><span class="p">,</span> <span class="s">&#39;wb&#39;</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfileobj</span><span class="p">(</span><span class="n">datasetfile</span><span class="o">.</span><span class="n">file</span><span class="p">,</span> <span class="n">permanent_data_file</span><span class="p">)</span>
        <span class="n">datasetfile</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">permanent_data_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">resourcefile</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">&#39;resourceszip&#39;</span><span class="p">]</span>
        <span class="n">resource_list</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">resourcesfilename</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="n">resourcefile</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
            <span class="n">resourcesfilename</span> <span class="o">=</span> <span class="n">resourcefile</span><span class="o">.</span><span class="n">filename</span>
            <span class="n">resfilepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">upload_dir</span><span class="p">,</span> <span class="n">resourcefile</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">,</span> <span class="s">&#39;_&#39;</span><span class="p">))</span>
            <span class="n">permanent_zip_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">resfilepath</span><span class="p">,</span> <span class="s">&#39;wb&#39;</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfileobj</span><span class="p">(</span><span class="n">resourcefile</span><span class="o">.</span><span class="n">file</span><span class="p">,</span> <span class="n">permanent_zip_file</span><span class="p">)</span>
            <span class="n">resourcefile</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">permanent_zip_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="n">zfile</span> <span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">resfilepath</span><span class="p">)</span>

            <span class="n">zfile</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">upload_dir</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-14'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-14'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">def</span> <span class="nf">dir_filter</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">upload_dir</span><span class="p">,</span> <span class="n">s</span><span class="p">)):</span>
                    <span class="k">return</span> <span class="bp">False</span>
                <span class="k">return</span> <span class="bp">True</span>


            <span class="n">resource_list</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="n">dir_filter</span><span class="p">,</span> <span class="n">zfile</span><span class="o">.</span><span class="n">namelist</span><span class="p">())</span>

        <span class="n">status</span><span class="p">,</span> <span class="n">err_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_uploadfile</span><span class="p">(</span><span class="n">datafilepath</span><span class="p">,</span> <span class="n">upload_dir</span><span class="p">,</span> <span class="n">resource_list</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="s">&quot;INVALID&quot;</span><span class="p">:</span>
            <span class="n">import_helper</span><span class="o">.</span><span class="n">delete_files</span><span class="p">(</span><span class="n">file_path</span><span class="o">=</span><span class="n">upload_dir</span><span class="p">,</span> <span class="n">ignore_files</span><span class="o">=</span><span class="p">[</span><span class="n">datafilename</span><span class="p">,</span> <span class="n">resourcesfilename</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_create_bulk_upload_record</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">user</span> <span class="ow">or</span> <span class="n">c</span><span class="o">.</span><span class="n">author</span><span class="p">,</span> <span class="n">datafilename</span><span class="p">,</span> <span class="n">resourcesfilename</span><span class="p">,</span> <span class="n">upload_dir</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span>
                                        <span class="n">err_msg</span><span class="p">)</span>

        <span class="n">url</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span><span class="n">controller</span><span class="o">=</span><span class="s">&#39;ckanext.ngds.ngdsui.controllers.contribute:ContributeController&#39;</span><span class="p">,</span>
                        <span class="n">action</span><span class="o">=</span><span class="s">&#39;bulk_upload&#39;</span><span class="p">)</span>
        <span class="n">redirect</span><span class="p">(</span><span class="n">url</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-15'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-15'>#</a>
      </div>
      <p>This function is responsible for validating a bulk upload.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_validate_uploadfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_file</span><span class="p">,</span> <span class="n">resource_path</span><span class="p">,</span> <span class="n">resource_list</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-16'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-16'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">err_msg</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">validator</span> <span class="o">=</span> <span class="n">ngdsvalidator</span><span class="o">.</span><span class="n">NGDSValidator</span><span class="p">(</span><span class="n">filepath</span><span class="o">=</span><span class="n">data_file</span><span class="p">,</span> <span class="n">resource_path</span><span class="o">=</span><span class="n">resource_path</span><span class="p">,</span>
                                                    <span class="n">resource_list</span><span class="o">=</span><span class="n">resource_list</span><span class="p">)</span>
            <span class="n">validator</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
            <span class="n">status</span> <span class="o">=</span> <span class="s">&quot;VALID&quot;</span>
            <span class="n">h</span><span class="o">.</span><span class="n">flash_notice</span><span class="p">(</span><span class="n">toolkit</span><span class="o">.</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;Files Uploaded Successfully.&#39;</span><span class="p">),</span> <span class="n">allow_html</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">err_msg</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">__str__</span><span class="p">()</span>
            <span class="n">h</span><span class="o">.</span><span class="n">flash_error</span><span class="p">(</span><span class="n">toolkit</span><span class="o">.</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;Uploaded files are invalid.: </span><span class="si">%s</span><span class="s"> &#39;</span><span class="p">)</span> <span class="o">%</span> <span class="n">err_msg</span><span class="p">,</span> <span class="n">allow_html</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">status</span> <span class="o">=</span> <span class="s">&quot;INVALID&quot;</span>

        <span class="k">return</span> <span class="n">status</span><span class="p">,</span> <span class="n">err_msg</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-17'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-17'>#</a>
      </div>
      <p>This function is responsible for creating a bulk upload record.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_create_bulk_upload_record</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">data_file</span><span class="p">,</span> <span class="n">resources</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">comments</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-18'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-18'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">userObj</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">User</span><span class="o">.</span><span class="n">by_name</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf8&#39;</span><span class="p">))</span>

        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;data_file&#39;</span><span class="p">:</span> <span class="n">data_file</span><span class="p">,</span> <span class="s">&#39;resources&#39;</span><span class="p">:</span> <span class="n">resources</span><span class="p">,</span> <span class="s">&#39;path&#39;</span><span class="p">:</span> <span class="n">path</span><span class="p">,</span> <span class="s">&#39;status&#39;</span><span class="p">:</span> <span class="n">status</span><span class="p">,</span> <span class="s">&#39;comments&#39;</span><span class="p">:</span> <span class="n">comments</span><span class="p">,</span>
                <span class="s">&#39;uploaded_by&#39;</span><span class="p">:</span> <span class="n">userObj</span><span class="o">.</span><span class="n">id</span><span class="p">}</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;model&#39;</span><span class="p">:</span> <span class="s">&#39;BulkUpload&#39;</span><span class="p">}</span>
        <span class="n">data_dict</span><span class="p">[</span><span class="s">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
        <span class="n">data_dict</span><span class="p">[</span><span class="s">&#39;process&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;create&#39;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-19'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-19'>#</a>
      </div>
      <p>print "Data dict: ",data_dict</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;model&#39;</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span> <span class="s">&#39;session&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">Session</span><span class="p">,</span> <span class="s">&#39;user&#39;</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">user</span> <span class="ow">or</span> <span class="n">c</span><span class="o">.</span><span class="n">author</span><span class="p">}</span>

        <span class="n">transaction_return</span> <span class="o">=</span> <span class="n">get_action</span><span class="p">(</span><span class="s">&#39;transaction_data&#39;</span><span class="p">)(</span><span class="n">context</span><span class="p">,</span> <span class="n">data_dict</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-20'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-20'>#</a>
      </div>
      <p>Creates the responsible party in the system and returns the node_id</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">create_responsible_party</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-21'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-21'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;model&#39;</span><span class="p">:</span> <span class="s">&#39;ResponsibleParty&#39;</span><span class="p">}</span>
        <span class="n">data_dict</span><span class="p">[</span><span class="s">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
        <span class="n">data_dict</span><span class="p">[</span><span class="s">&#39;process&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;create&#39;</span>

        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;model&#39;</span><span class="p">:</span> <span class="n">model</span><span class="p">}</span>

        <span class="n">data_dict</span> <span class="o">=</span> <span class="n">get_action</span><span class="p">(</span><span class="s">&#39;additional_metadata&#39;</span><span class="p">)(</span><span class="n">context</span><span class="p">,</span> <span class="n">data_dict</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-22'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-22'>#</a>
      </div>
      <p>responsible.save()</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">return</span> <span class="n">data_dict</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-23'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-23'>#</a>
      </div>
      <p>Creates the responsible party in the system and returns the node_id</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">update_responsible_party</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-24'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-24'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;model&#39;</span><span class="p">:</span> <span class="s">&#39;ResponsibleParty&#39;</span><span class="p">}</span>
        <span class="n">data_dict</span><span class="p">[</span><span class="s">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
        <span class="n">data_dict</span><span class="p">[</span><span class="s">&#39;process&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;update&#39;</span>

        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;model&#39;</span><span class="p">:</span> <span class="n">model</span><span class="p">}</span>

        <span class="n">data_dict</span> <span class="o">=</span> <span class="n">get_action</span><span class="p">(</span><span class="s">&#39;additional_metadata&#39;</span><span class="p">)(</span><span class="n">context</span><span class="p">,</span> <span class="n">data_dict</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-25'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-25'>#</a>
      </div>
      <p>responsible.save()</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">return</span> <span class="n">data_dict</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-26'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-26'>#</a>
      </div>
      <p>This function is responsible for rendering the bulk upload list page which in turn displays all the bulk uploads submitted to the system.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">bulkupload_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-27'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-27'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;model&#39;</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span> <span class="s">&#39;session&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">Session</span><span class="p">,</span> <span class="s">&#39;user&#39;</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">user</span> <span class="ow">or</span> <span class="n">c</span><span class="o">.</span><span class="n">author</span><span class="p">}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">check_access</span><span class="p">(</span><span class="s">&#39;package_create&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">NotAuthorized</span><span class="p">,</span> <span class="n">error</span><span class="p">:</span>
            <span class="n">err_str</span> <span class="o">=</span> <span class="n">toolkit</span><span class="o">.</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;User </span><span class="si">%s</span><span class="s"> not authorized to access bulk uploads&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="n">c</span><span class="o">.</span><span class="n">user</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-28'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-28'>#</a>
      </div>
      <p>abort(401,error.<strong>str</strong>())    </p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">abort</span><span class="p">(</span><span class="mi">401</span><span class="p">,</span> <span class="n">err_str</span><span class="p">)</span>

        <span class="n">uploads</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">BulkUpload</span><span class="o">.</span><span class="n">get_all</span><span class="p">()</span>

        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;model&#39;</span><span class="p">:</span> <span class="s">&#39;BulkUpload&#39;</span><span class="p">}</span>
        <span class="n">data_dict</span><span class="p">[</span><span class="s">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
        <span class="n">data_dict</span><span class="p">[</span><span class="s">&#39;process&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;read&#39;</span>
        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;model&#39;</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span> <span class="s">&#39;session&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">Session</span><span class="p">}</span>
        <span class="n">c</span><span class="o">.</span><span class="n">bulkuploads</span> <span class="o">=</span> <span class="n">uploads</span>

        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="s">&#39;contribute/bulkupload_list.html&#39;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-29'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-29'>#</a>
      </div>
      <p>This function is responsible for displaying the list of packages that constitute a given bulk upload submission.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">bulkupload_package_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-30'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-30'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;model&#39;</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span> <span class="s">&#39;session&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">Session</span><span class="p">,</span> <span class="s">&#39;user&#39;</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">user</span> <span class="ow">or</span> <span class="n">c</span><span class="o">.</span><span class="n">author</span><span class="p">}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">check_access</span><span class="p">(</span><span class="s">&#39;package_create&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">NotAuthorized</span><span class="p">,</span> <span class="n">error</span><span class="p">:</span>
            <span class="n">err_str</span> <span class="o">=</span> <span class="n">toolkit</span><span class="o">.</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;User </span><span class="si">%s</span><span class="s"> not authorized to access bulk uploads&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="n">c</span><span class="o">.</span><span class="n">user</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-31'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-31'>#</a>
      </div>
      <p>abort(401,error.<strong>str</strong>())    </p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">abort</span><span class="p">(</span><span class="mi">401</span><span class="p">,</span> <span class="n">err_str</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">clean_dict</span><span class="p">(</span><span class="n">unflatten</span><span class="p">(</span><span class="n">tuplize_dict</span><span class="p">(</span><span class="n">parse_params</span><span class="p">(</span>
            <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">))))</span>

        <span class="n">uploaded_packages</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">BulkUpload_Package</span><span class="o">.</span><span class="n">by_bulk_upload</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">])</span>

        <span class="n">c</span><span class="o">.</span><span class="n">uploaded_packages</span> <span class="o">=</span> <span class="n">uploaded_packages</span>
        <span class="n">c</span><span class="o">.</span><span class="n">selected_upload</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">BulkUpload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="s">&#39;contribute/bulkupload_list.html&#39;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-32'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-32'>#</a>
      </div>
      <p>Executes a bulk upload job. This function can only be triggered by an admin via the bulk upload page.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">execute_bulkupload</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-33'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-33'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;model&#39;</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span> <span class="s">&#39;session&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">Session</span><span class="p">,</span> <span class="s">&#39;user&#39;</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">user</span> <span class="ow">or</span> <span class="n">c</span><span class="o">.</span><span class="n">author</span><span class="p">}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">check_access</span><span class="p">(</span><span class="s">&#39;execute_bulkupload&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">NotAuthorized</span><span class="p">,</span> <span class="n">error</span><span class="p">:</span>
            <span class="n">abort</span><span class="p">(</span><span class="mi">401</span><span class="p">,</span> <span class="n">error</span><span class="o">.</span><span class="n">__str__</span><span class="p">())</span>

        <span class="kn">from</span> <span class="nn">ckanext.ngds.importer.importer</span> <span class="kn">import</span> <span class="n">BulkUploader</span>

        <span class="n">bulkLoader</span> <span class="o">=</span> <span class="n">BulkUploader</span><span class="p">()</span>
        <span class="n">bulkLoader</span><span class="o">.</span><span class="n">execute_bulk_upload</span><span class="p">()</span>

        <span class="n">h</span><span class="o">.</span><span class="n">flash_notice</span><span class="p">(</span><span class="n">toolkit</span><span class="o">.</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;Initiated Bulk Upload process and it is running in the background.&#39;</span><span class="p">),</span> <span class="n">allow_html</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span><span class="n">controller</span><span class="o">=</span><span class="s">&#39;ckanext.ngds.ngdsui.controllers.contribute:ContributeController&#39;</span><span class="p">,</span>
                        <span class="n">action</span><span class="o">=</span><span class="s">&#39;bulkupload_list&#39;</span><span class="p">)</span>
        <span class="n">redirect</span><span class="p">(</span><span class="n">url</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-34'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-34'>#</a>
      </div>
      <p>Validate a resource to ensure that it conforms to NGDS standards. For ex: if a resource specifies that it conforms to a content model, that validation occurs here.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@jsonify</span>
    <span class="k">def</span> <span class="nf">validate_resource</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-35'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-35'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">data</span> <span class="o">=</span> <span class="n">clean_dict</span><span class="p">(</span><span class="n">unflatten</span><span class="p">(</span><span class="n">tuplize_dict</span><span class="p">(</span><span class="n">parse_params</span><span class="p">(</span>
            <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">))))</span>

        <span class="k">return</span> <span class="n">toolkit</span><span class="o">.</span><span class="n">get_action</span><span class="p">(</span><span class="s">&quot;validate_resource&quot;</span><span class="p">)(</span><span class="bp">None</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-36'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-36'>#</a>
      </div>
      <p>Executes the fulltext indexer to index documents that were uploaded since the last indexer run.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">execute_fulltext_indexer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-37'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-37'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">process_resource_docs_to_index</span><span class="p">()</span>

        <span class="k">return</span> <span class="s">&quot;Full text indexer is executed successfully. Have fun with searching through documents.....&quot;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-38'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-38'>#</a>
      </div>
      <p>Process a dataset metadata submission and validate it. If valid, then proceed to add the dataset metadata and if not return the new_package_metadata page to display the errors so
the user can try to fix his submission.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">new_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-39'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-39'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">data</span> <span class="o">=</span> <span class="n">clean_dict</span><span class="p">(</span><span class="n">unflatten</span><span class="p">(</span><span class="n">tuplize_dict</span><span class="p">(</span><span class="n">parse_params</span><span class="p">(</span>
            <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">))))</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">toolkit</span><span class="o">.</span><span class="n">get_action</span><span class="p">(</span><span class="s">&#39;validate_dataset_metadata&#39;</span><span class="p">)(</span><span class="bp">None</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="nb">vars</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;data&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s">&#39;success&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">PackageController</span><span class="p">()</span><span class="o">.</span><span class="n">new_metadata</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;pkg_name&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">vars</span><span class="p">[</span><span class="s">&quot;errors&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s">&quot;errors&quot;</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="s">&#39;package/new_package_metadata.html&#39;</span><span class="p">,</span> <span class="n">extra_vars</span><span class="o">=</span><span class="nb">vars</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-40'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-40'>#</a>
      </div>
      <p>TODO : Is this really needed?
def additional_metadata(self):
    data = clean_dict(unflatten(tuplize_dict(parse_params(
        request.params))))
    return toolkit.get_action('validate_dataset_metadata')(None, data)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
</div>
</body>
