<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>helpers.py</title>
  <link rel="stylesheet" href="../../../../pycco.css">
</head>
<body>
<div id="background"></div>
<div id='container'>
  <div class='section'>
    <div class='docs'><h1>helpers.py</h1></div>
  </div>
  <div class='clearall'>
  <div class='section' id='section-0'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-0'>#</a>
      </div>
      <p>This file defines a list of helper functions that are used from the site templates to obtain data that may not be available at the time of rendering, or to process information on the fly.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="kn">from</span> <span class="nn">ckan.lib.base</span> <span class="kn">import</span> <span class="n">model</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span>
<span class="kn">import</span> <span class="nn">ckan.lib.navl.dictization_functions</span> <span class="kn">as</span> <span class="nn">dictization_functions</span>
<span class="kn">import</span> <span class="nn">ckan.controllers.storage</span> <span class="kn">as</span> <span class="nn">storage</span>
<span class="kn">from</span> <span class="nn">webhelpers.html</span> <span class="kn">import</span> <span class="n">literal</span>
<span class="kn">import</span> <span class="nn">ckan.rating</span> <span class="kn">as</span> <span class="nn">rating</span>

<span class="n">DataError</span> <span class="o">=</span> <span class="n">dictization_functions</span><span class="o">.</span><span class="n">DataError</span>
<span class="kn">from</span> <span class="nn">pylons</span> <span class="kn">import</span> <span class="n">config</span><span class="p">,</span> <span class="n">jsonify</span>
<span class="kn">import</span> <span class="nn">ckan.logic</span> <span class="kn">as</span> <span class="nn">logic</span>

<span class="kn">from</span> <span class="nn">ckanext.ngds.env</span> <span class="kn">import</span> <span class="n">ckan_model</span>

<span class="kn">import</span> <span class="nn">iso8601</span>
<span class="kn">import</span> <span class="nn">urllib2</span>

<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">ckan.model.resource</span> <span class="kn">import</span> <span class="n">Resource</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">ckan.plugins</span> <span class="kn">as</span> <span class="nn">p</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="kn">from</span> <span class="nn">ckan.plugins</span> <span class="kn">import</span> <span class="n">toolkit</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span> <span class="c"># 2.7</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">sqlalchemy.util</span> <span class="kn">import</span> <span class="n">OrderedDict</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-1'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-1'>#</a>
      </div>
      <p>Get the name of a responsible party for an id.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">get_responsible_party_name</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-2'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-2'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">print</span> <span class="s">&quot;get_responsible_party_name  &quot;</span>
    <span class="k">print</span> <span class="nb">id</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-3'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-3'>#</a>
      </div>
      <p>print inspect.stack()
frm = inspect.stack()[0]
mod = inspect.getmodule(frm[0])
print '[%s] %s' % (mod.<strong>name</strong>, id)
If we don't get an int id, return an empty string.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="nb">id</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">id_int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
        <span class="k">except</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&quot;&quot;</span>
        <span class="n">responsible_party</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">ResponsibleParty</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">responsible_party</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">responsible_party</span><span class="o">.</span><span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&quot;&quot;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-4'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-4'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">get_login_url</span><span class="p">():</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">url</span>
    <span class="k">print</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">h</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span><span class="n">_get_repoze_handler</span><span class="p">(</span><span class="s">&#39;login_handler_path&#39;</span><span class="p">),</span> <span class="n">came_from</span><span class="o">=</span><span class="n">x</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-5'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-5'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">_get_repoze_handler</span><span class="p">(</span><span class="n">handler_name</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Returns the URL that repoze.who will respond to and perform a</span>
<span class="sd">    login or logout.&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;repoze.who.plugins&#39;</span><span class="p">][</span><span class="s">&#39;friendlyform&#39;</span><span class="p">],</span> <span class="n">handler_name</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-6'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-6'>#</a>
      </div>
      <p>Returns the default group name that is configured in the site configuration file.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">get_default_group</span><span class="p">():</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-7'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-7'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">default_group_id</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">default_group_id</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">default_group</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">default_group_id</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;ngds.default_group_name&#39;</span><span class="p">,</span> <span class="s">&#39;public&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">default_group_id</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-8'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-8'>#</a>
      </div>
      <p>Accepts a rating value and returns a 1 to indicate that a star must be highlighted on the UI to indicate a rating, and a 0 to not highlight it.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">highlight_rating_star</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">packageId</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-9'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-9'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">package</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Package</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">packageId</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rating</span><span class="o">.</span><span class="n">get_rating</span><span class="p">(</span><span class="n">package</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">count</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-10'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-10'>#</a>
      </div>
      <p>Returns the average rating of a package for a given package id and the number of ratings.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">get_rating_details</span><span class="p">(</span><span class="n">package_id</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-11'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-11'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">rating_obj</span> <span class="o">=</span> <span class="n">rating</span><span class="o">.</span><span class="n">get_rating</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Package</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">package_id</span><span class="p">))</span>
    <span class="n">rating_v</span> <span class="o">=</span> <span class="n">rating_obj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="mi">0</span>
    <span class="n">ratings_count</span> <span class="o">=</span> <span class="n">rating_obj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">rnd</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">rating_v</span><span class="p">)</span>
    <span class="n">intv</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">rnd</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">intv</span><span class="p">,</span> <span class="n">ratings_count</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-12'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-12'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">count_rating_reviews</span><span class="p">(</span><span class="n">packageId</span><span class="p">):</span>
    <span class="n">package</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Package</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">packageId</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rating</span><span class="o">.</span><span class="n">get_rating</span><span class="p">(</span><span class="n">package</span><span class="p">)):</span>
        <span class="k">return</span> <span class="n">rating</span><span class="o">.</span><span class="n">get_rating</span><span class="p">(</span><span class="n">package</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-13'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-13'>#</a>
      </div>
      <p>Returns the text to be displayed for a given rating value</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">rating_text</span><span class="p">(</span><span class="n">count</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-14'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-14'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">toolkit</span><span class="o">.</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Rate as very poor?&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">toolkit</span><span class="o">.</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Rate as poor?&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">toolkit</span><span class="o">.</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Rate as fair?&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">toolkit</span><span class="o">.</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Rate as good?&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">toolkit</span><span class="o">.</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Rate as very good?&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-15'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-15'>#</a>
      </div>
      <p>Returns the language name for a given language id.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">get_language</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-16'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-16'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="nb">id</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">id_int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
        <span class="k">except</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&quot;&quot;</span>
        <span class="n">language</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Language</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
        <span class="k">print</span> <span class="n">language</span><span class="o">.</span><span class="n">name</span>
        <span class="k">if</span> <span class="n">language</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">language</span><span class="o">.</span><span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&quot;&quot;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-17'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-17'>#</a>
      </div>
      <p>Given a file's URL, find the file itself on this system</p>
<p>@param url: The URL for a file that lives on this server
@return: the file path to the file itself</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">file_path_from_url</span><span class="p">(</span><span class="n">url</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-18'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-18'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">pattern</span> <span class="o">=</span> <span class="s">&quot;^(?P&lt;protocol&gt;.+?)://(?P&lt;host&gt;.+?)/.+/(?P&lt;label&gt;\d{4}-.+)$&quot;</span>
    <span class="n">label</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s">&quot;label&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">get_url_for_file</span><span class="p">(</span><span class="n">urllib2</span><span class="o">.</span><span class="n">unquote</span><span class="p">(</span><span class="n">label</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-19'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-19'>#</a>
      </div>
      <p>Returns the URL for a file given it's label.
:return:</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">get_url_for_file</span><span class="p">(</span><span class="n">label</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-20'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-20'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">bucket</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;ckan.storage.bucket&#39;</span><span class="p">,</span> <span class="s">&#39;default&#39;</span><span class="p">)</span>
    <span class="n">ofs</span> <span class="o">=</span> <span class="n">storage</span><span class="o">.</span><span class="n">get_ofs</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">ofs</span><span class="o">.</span><span class="n">get_url</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;file://&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-21'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-21'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">is_plugin_enabled</span><span class="p">(</span><span class="n">plugin</span><span class="p">):</span>
    <span class="n">plugins</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;ckan.plugins&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">plugin</span> <span class="ow">in</span> <span class="n">plugins</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">return</span> <span class="bp">False</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-22'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-22'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">username_for_id</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">User</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span><span class="o">.</span><span class="n">name</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-23'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-23'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">get_formatted_date</span><span class="p">(</span><span class="n">timestamp</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">iso8601</span><span class="o">.</span><span class="n">parse_date</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%B </span><span class="si">%d</span><span class="s">,%Y&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-24'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-24'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">get_formatted_date_from_obj</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">isdate</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">isdate</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">timestamp</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%b </span><span class="si">%d</span><span class="s">, %Y %H:%M&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">iso8601</span><span class="o">.</span><span class="n">parse_date</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%b </span><span class="si">%d</span><span class="s">,%Y %H:%M&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-25'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-25'>#</a>
      </div>
      <p>This method loads the ngds facet configuration file and finds the facets to be during the search.</p>
<pre><code>**Parameters:**
None.

**Results:**
:returns: The facets dict to be used for search.
:rtype: OrderedDict
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">load_ngds_facets</span><span class="p">():</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-26'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-26'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-27'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-27'>#</a>
      </div>
      <p>Return the loaded facets from global context if available. This will avoid unnecssary reading of config file everytime during search.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">loaded_facets</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">loaded_facets</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;facets are yet to be loaded from the config.&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-28'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-28'>#</a>
      </div>
      <p>Read the facet config file path from application config file (developement.ini)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">facets_config_path</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;ngds.facets_config&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">facets_config_path</span><span class="p">:</span>
        <span class="n">loaded_facets</span> <span class="o">=</span> <span class="n">read_facets_json</span><span class="p">(</span><span class="n">facets_config_path</span><span class="o">=</span><span class="n">facets_config_path</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-29'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-29'>#</a>
      </div>
      <p>If facets are loaded and available then set them in global context and return.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="n">loaded_facets</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">loaded_facets</span> <span class="o">=</span> <span class="n">loaded_facets</span>
        <span class="n">facets_dict</span> <span class="o">=</span> <span class="n">loaded_facets</span>

    <span class="k">return</span> <span class="n">facets_dict</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-30'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-30'>#</a>
      </div>
      <p>This Method loads the given facets config file and constructs the facets structure to be used.
    <strong>Parameters:</strong>
    facets_config_path - Facets Configuration file (json file) path.</p>
<pre><code>**Results:**
:returns: The facets dict to be used for search.
:rtype: OrderedDict
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">read_facets_json</span><span class="p">(</span><span class="n">facets_config_path</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-31'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-31'>#</a>
      </div>
      <p>Open the json config file and load it as dict.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">facets_config_path</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">json</span>
        <span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>

        <span class="n">json_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-32'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-32'>#</a>
      </div>
      <p>Dict structure of json config file is placed on global context for future use.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">g</span><span class="o">.</span><span class="n">facet_json_data</span> <span class="o">=</span> <span class="n">json_data</span>

        <span class="n">facets_list</span> <span class="o">=</span> <span class="p">[]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-33'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-33'>#</a>
      </div>
      <p>Pass each facet to read_facet method to find the list of fields.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">for</span> <span class="n">facet</span> <span class="ow">in</span> <span class="n">json_data</span><span class="p">:</span>
            <span class="n">facets_list</span> <span class="o">=</span> <span class="n">read_facet</span><span class="p">(</span><span class="n">facet</span><span class="p">,</span> <span class="n">facets_list</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">facets_list</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="n">facets_list</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-34'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-34'>#</a>
      </div>
      <p>Reads the input facet_config and its subfacets to find the metadatafields which will be used to used as facets.
    <strong>Parameters:</strong>
    facet_struc - Particular facet structure to be iterated.
    facets_list - list of found facets to which new facets needs to be added into.</p>
<pre><code>**Results:**
:returns: The facets list
:rtype: list
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">read_facet</span><span class="p">(</span><span class="n">facet_struc</span><span class="p">,</span> <span class="n">facet_list</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-35'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-35'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-36'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-36'>#</a>
      </div>
      <p>If the metadatafield exists in the facet then add it to the list.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="n">facet_struc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;metadatafield&quot;</span><span class="p">):</span>
        <span class="n">facet_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">(</span><span class="n">facet_struc</span><span class="p">[</span><span class="s">&#39;metadatafield&#39;</span><span class="p">],</span> <span class="n">toolkit</span><span class="o">.</span><span class="n">_</span><span class="p">(</span><span class="n">facet_struc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;facet&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">facet_struc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;display_name&quot;</span><span class="p">))))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-37'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-37'>#</a>
      </div>
      <p>If subfacet exists then iterate through entire structure to find the remaining facets.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="n">facet_struc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;subfacet&quot;</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">subfacet</span> <span class="ow">in</span> <span class="n">facet_struc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;subfacet&quot;</span><span class="p">):</span>
            <span class="n">facet_list</span> <span class="o">=</span> <span class="n">read_facet</span><span class="p">(</span><span class="n">subfacet</span><span class="p">,</span> <span class="n">facet_list</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">facet_list</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-38'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-38'>#</a>
      </div>
      <p>This method gets the facets from search results and construct them into NGDS specific structure based on the facet json config file.</p>
<pre><code>**Parameters:**
None.

**Results:**
:returns: Faceted results dict found from the results.
:rtype: Dict
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">get_ngdsfacets</span><span class="p">():</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-39'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-39'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">facet_config</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">facet_json_data</span>

    <span class="n">facets</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">facet_group</span> <span class="ow">in</span> <span class="n">facet_config</span><span class="p">:</span>
        <span class="n">facet_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">facets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">construct_facet</span><span class="p">(</span><span class="n">facet_group</span><span class="p">,</span> <span class="n">facet_dict</span><span class="o">=</span><span class="n">facet_dict</span><span class="p">,</span> <span class="n">facet_level</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">facets</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-40'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-40'>#</a>
      </div>
      <p>This method constructs the facet results for each Facet structure (from json file)</p>
<pre><code>**Parameters:**
facet_group - Facet Structure to be filled based on results.
facet_dict - newly constrcuted facets dict which needs to be appended with new values.
metadatafield - Metadata field of the facet.
facet_level - 1 - Top level facet 2 - Other sub level facets.
facet_values - Values of the facets returned from search.

**Results:**
:returns: Constructed faceted dict from the input facet structure and the results.
:rtype: Dict
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">construct_facet</span><span class="p">(</span><span class="n">facet_group</span><span class="p">,</span> <span class="n">facet_dict</span><span class="o">=</span><span class="p">{},</span> <span class="n">metadatafield</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">facet_level</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">facet_values</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-41'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-41'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-42'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-42'>#</a>
      </div>
      <p>If metadatafield exists, then get the faceted values from the search results.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="n">facet_group</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;metadatafield&quot;</span><span class="p">):</span>
        <span class="n">metadatafield</span> <span class="o">=</span> <span class="n">facet_group</span><span class="p">[</span><span class="s">&#39;metadatafield&#39;</span><span class="p">]</span>
        <span class="n">facet_dict</span><span class="p">[</span><span class="s">&#39;facet_field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadatafield</span>
        <span class="n">facet_values</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">get_facet_items_dict</span><span class="p">(</span><span class="n">metadatafield</span><span class="p">)</span>

    <span class="n">facet_type</span> <span class="o">=</span> <span class="n">facet_group</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;type&quot;</span><span class="p">)</span>

    <span class="n">facet_dict</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">facet_type</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-43'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-43'>#</a>
      </div>
      <p>Display type of the field is determined here. If the facet level is 1 (i.e. called from get_ngdsfacets()) then it shld be top level title.
Otherwise it will be sub-title. In some cases, top level facet itself will be of type dynamic_keywords. Those types shld be displayed as titles.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="n">facet_type</span> <span class="o">==</span> <span class="s">&quot;title&quot;</span> <span class="ow">or</span> <span class="p">(</span><span class="n">facet_type</span> <span class="o">==</span> <span class="s">&quot;dynamic_keywords&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">facet_group</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;subfacet&quot;</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">facet_level</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">display_type</span> <span class="o">=</span> <span class="s">&quot;title&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">display_type</span> <span class="o">=</span> <span class="s">&quot;subtitle&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">display_type</span> <span class="o">=</span> <span class="s">&quot;facet&quot;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-44'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-44'>#</a>
      </div>
      <p>If the displaye_name exits then display that otherwise display facet itself.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">facet_dict</span><span class="p">[</span><span class="s">&#39;display_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">facet_group</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;display_name&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">facet_group</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;facet&#39;</span><span class="p">)</span>
    <span class="n">facet_dict</span><span class="p">[</span><span class="s">&#39;display_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">display_type</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-45'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-45'>#</a>
      </div>
      <p>if the facet_type is dynamic_keywords then there won't be any sub-facets. Display those dynamic facet values .</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="n">facet_group</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;dynamic_keywords&#39;</span><span class="p">:</span>
        <span class="n">facet_dict</span><span class="p">[</span><span class="s">&#39;fvalues&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">facet_values</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-46'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-46'>#</a>
      </div>
      <p>If the facet_type is "keyword" then it has to be compared with the results for the count. If matches then remove that from the results so that it won't be in the others list.
If the facet is not matching with any results, then create a dummy facet with count 0.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="n">facet_group</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;keyword&#39;</span><span class="p">:</span>
        <span class="n">found</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">for</span> <span class="n">ret_facet</span> <span class="ow">in</span> <span class="n">facet_values</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-47'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-47'>#</a>
      </div>
      <p>print "ret_facet['name']: ",ret_facet['name']</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">ret_facet</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">facet_group</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;facet&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">ret_facet</span><span class="p">[</span><span class="s">&#39;display_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">facet_group</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;display_name&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">facet_group</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;facet&#39;</span><span class="p">)</span>
                <span class="n">facet_dict</span><span class="p">[</span><span class="s">&#39;fvalues&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">ret_facet</span><span class="p">]</span>
                <span class="n">found</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">facet_values</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">ret_facet</span><span class="p">)</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
            <span class="n">active</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">if</span> <span class="n">display_type</span> <span class="o">==</span> <span class="s">&quot;facet&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">facet_dict</span><span class="p">[</span><span class="s">&#39;facet_field&#39;</span><span class="p">],</span> <span class="n">facet_group</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;facet&#39;</span><span class="p">))</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">active</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">facet_dict</span><span class="p">[</span><span class="s">&#39;fvalues&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[{</span><span class="s">&#39;count&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;active&#39;</span><span class="p">:</span> <span class="n">active</span><span class="p">,</span> <span class="s">&#39;display_name&#39;</span><span class="p">:</span> <span class="n">facet_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;display_name&#39;</span><span class="p">),</span>
                                      <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="n">facet_group</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;facet&#39;</span><span class="p">)}]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-48'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-48'>#</a>
      </div>
      <p>If subfacet exists in the facet then iterate through the entire sub-facet structure to construct the results.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="n">facet_group</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;subfacet&quot;</span><span class="p">):</span>
        <span class="n">subfacet_dict</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">subfacet</span> <span class="ow">in</span> <span class="n">facet_group</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;subfacet&quot;</span><span class="p">):</span>
            <span class="n">subfacet_dict</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">construct_facet</span><span class="p">(</span><span class="n">subfacet</span><span class="p">,</span> <span class="n">facet_dict</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;facet_field&quot;</span><span class="p">:</span> <span class="n">metadatafield</span><span class="p">},</span> <span class="n">metadatafield</span><span class="o">=</span><span class="n">metadatafield</span><span class="p">,</span>
                                <span class="n">facet_level</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">facet_values</span><span class="o">=</span><span class="n">facet_values</span><span class="p">))</span>
        <span class="n">facet_dict</span><span class="p">[</span><span class="s">&#39;subfacet&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">subfacet_dict</span>

    <span class="k">return</span> <span class="n">facet_dict</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-49'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-49'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">get_formatted_date</span><span class="p">(</span><span class="n">datstr</span><span class="p">):</span>
    <span class="n">formated_string</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">datstr</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

        <span class="n">formated_string</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">datstr</span><span class="p">[:</span><span class="mi">10</span><span class="p">],</span> <span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;%b </span><span class="si">%d</span><span class="s">,%Y&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">formated_string</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-50'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-50'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">to_json</span><span class="p">(</span><span class="n">data</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-51'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-51'>#</a>
      </div>
      <p>print json.dumps(data)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-52'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-52'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">is_string_field</span><span class="p">(</span><span class="n">field_name</span><span class="p">):</span>
    <span class="n">non_string_fields</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;publication_date&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">non_string_fields</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span><span class="p">;</span>

    <span class="k">return</span> <span class="bp">True</span><span class="p">;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-53'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-53'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">get_field_title</span><span class="p">(</span><span class="n">field_name</span><span class="p">):</span>
    <span class="n">field_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;publication_date&#39;</span><span class="p">:</span> <span class="s">&#39;Publication Date&#39;</span><span class="p">,</span> <span class="s">&#39;metadata_created&#39;</span><span class="p">:</span> <span class="s">&#39;Created Date&#39;</span><span class="p">}</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">field_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">x</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-54'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-54'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">is_ogc_publishable</span><span class="p">(</span><span class="n">resource_id</span><span class="p">):</span>
    <span class="n">resource</span> <span class="o">=</span> <span class="n">Resource</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">resource_id</span><span class="p">)</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">url</span>
    <span class="k">if</span> <span class="n">url</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">url</span><span class="p">)]</span> <span class="o">==</span> <span class="s">&#39;zip&#39;</span> <span class="ow">or</span> <span class="n">url</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">url</span><span class="p">)]</span> <span class="o">==</span> <span class="s">&#39;csv&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">return</span> <span class="bp">False</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-55'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-55'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@jsonify</span>
<span class="k">def</span> <span class="nf">jsonify</span><span class="p">(</span><span class="nb">input</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-56'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-56'>#</a>
      </div>
      <p>Trivial as this may seem, it is neccessary.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&#39;Content-Type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;text/html;charset=utf-8&#39;</span>
    <span class="k">return</span> <span class="nb">input</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-57'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-57'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">get_usersearches</span><span class="p">():</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">User</span><span class="o">.</span><span class="n">by_name</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf8&#39;</span><span class="p">))</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">UserSearch</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-58'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-58'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">parseJSON</span><span class="p">(</span><span class="nb">input</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">json_parsed</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
    <span class="k">except</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="s">&quot;{}&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">json_parsed</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-59'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-59'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">json_extract</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">input</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">input</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;ascii&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;&amp;#34;&quot;</span><span class="p">,</span> <span class="s">&#39;&quot;&#39;</span><span class="p">)</span>
        <span class="n">i_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">i_json</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;Found : &quot;</span> <span class="o">+</span> <span class="n">i_json</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot; for key : &quot;</span> <span class="o">+</span> <span class="n">key</span>
            <span class="k">return</span> <span class="n">i_json</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="k">except</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&#39;&#39;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-60'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-60'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">get_dataset_category_image_path</span><span class="p">(</span><span class="n">package</span><span class="p">):</span>
    <span class="n">image_path</span> <span class="o">=</span> <span class="s">&#39;/assets/dataset.png&#39;</span>

    <span class="n">dataset_category</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">for</span> <span class="n">extra</span> <span class="ow">in</span> <span class="n">package</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;extras&#39;</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">extra</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;key&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">and</span> <span class="n">key</span> <span class="o">==</span> <span class="s">&#39;data_type&#39;</span><span class="p">:</span>
            <span class="n">dataset_category</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">extra</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;value&#39;</span><span class="p">))</span>
            <span class="k">break</span>

    <span class="n">category_image_link</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;Dataset&#39;</span><span class="p">:</span> <span class="s">&#39;/assets/dataset.png&#39;</span><span class="p">,</span>
        <span class="s">&#39;Physical Collection&#39;</span><span class="p">:</span> <span class="s">&#39;/assets/physicalcollection.png&#39;</span><span class="p">,</span>
        <span class="s">&#39;Catalog&#39;</span><span class="p">:</span> <span class="s">&#39;/assets/catalog.png&#39;</span><span class="p">,</span>
        <span class="s">&#39;Movie or Video&#39;</span><span class="p">:</span> <span class="s">&#39;/assets/video.png&#39;</span><span class="p">,</span>
        <span class="s">&#39;Drawing&#39;</span><span class="p">:</span> <span class="s">&#39;/assets/drawing.png&#39;</span><span class="p">,</span>
        <span class="s">&#39;Photograph&#39;</span><span class="p">:</span> <span class="s">&#39;/assets/photograph.png&#39;</span><span class="p">,</span>
        <span class="s">&#39;Remotely-Sensed Image&#39;</span><span class="p">:</span> <span class="s">&#39;/assets/remotelysensedimage.png&#39;</span><span class="p">,</span>
        <span class="s">&#39;Map&#39;</span><span class="p">:</span> <span class="s">&#39;/assets/map.png&#39;</span><span class="p">,</span>
        <span class="s">&#39;Text Document&#39;</span><span class="p">:</span> <span class="s">&#39;/assets/text_document.png&#39;</span><span class="p">,</span>
        <span class="s">&#39;Physical Artifact&#39;</span><span class="p">:</span> <span class="s">&#39;/assets/physicalcollection.png&#39;</span><span class="p">,</span>
        <span class="s">&#39;Desktop Application&#39;</span><span class="p">:</span> <span class="s">&#39;/assets/dataset.png&#39;</span><span class="p">,</span>
        <span class="s">&#39;Web Application&#39;</span><span class="p">:</span> <span class="s">&#39;/assets/dataset.png&#39;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">dataset_category</span> <span class="ow">and</span> <span class="n">dataset_category</span> <span class="ow">in</span> <span class="n">category_image_link</span><span class="p">:</span>
        <span class="n">image_path</span> <span class="o">=</span> <span class="n">category_image_link</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dataset_category</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">image_path</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-61'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-61'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">is_following</span><span class="p">(</span><span class="n">obj_type</span><span class="p">,</span> <span class="n">obj_id</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Return a true/False based on follow for the given object type and id.</span>

<span class="sd">    If the user is not logged in return an empty string instead.</span>

<span class="sd">    :param obj_type: the type of the object to be followed when the follow</span>
<span class="sd">        button is clicked, e.g. &#39;user&#39; or &#39;dataset&#39;</span>
<span class="sd">    :type obj_type: string</span>
<span class="sd">    :param obj_id: the id of the object to be followed when the follow button</span>
<span class="sd">        is clicked</span>
<span class="sd">    :type obj_id: string</span>

<span class="sd">    :returns: a follow button as an HTML snippet</span>
<span class="sd">    :rtype: string</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">obj_type</span> <span class="o">=</span> <span class="n">obj_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-62'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-62'>#</a>
      </div>
      <p>If the user is logged in show the follow/unfollow button</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">following</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;model&#39;</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span> <span class="s">&#39;session&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">Session</span><span class="p">,</span> <span class="s">&#39;user&#39;</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">user</span><span class="p">}</span>
        <span class="n">action</span> <span class="o">=</span> <span class="s">&#39;am_following_</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">obj_type</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-63'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-63'>#</a>
      </div>
      <p>following = logic.get_action(action)(context, {'id': obj_id})</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">return</span> <span class="bp">True</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-64'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-64'>#</a>
      </div>
      <p>Creates entry for the documents to be full-text indexed for a particular dataset or package. (resource_document_index table).
Before creating new entries, existing to be indexed (status as 'NEW') entries are updated as 'CANCEL'.
:returns: True after creating entries in db.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">create_package_resource_document_index</span><span class="p">(</span><span class="n">pkg_id</span><span class="p">,</span> <span class="n">resource_dict_list</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-65'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-65'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="kn">from</span> <span class="nn">ckanext.ngds.metadata.controllers.transaction_data</span> <span class="kn">import</span> <span class="n">dispatch</span> <span class="k">as</span> <span class="n">trans_dispatch</span>

    <span class="n">ckan_model</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="s">&quot;UPDATE public.resource_document_index SET status=:status_val where package_id=:pkg_id and status=:old_status&quot;</span><span class="p">,</span>
        <span class="p">{</span><span class="s">&#39;status_val&#39;</span><span class="p">:</span> <span class="s">&#39;CANCEL&#39;</span><span class="p">,</span> <span class="s">&#39;pkg_id&#39;</span><span class="p">:</span> <span class="n">pkg_id</span><span class="p">,</span> <span class="s">&#39;old_status&#39;</span><span class="p">:</span> <span class="s">&#39;NEW&#39;</span><span class="p">})</span>

    <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;model&#39;</span><span class="p">:</span> <span class="s">&#39;DocumentIndex&#39;</span><span class="p">}</span>
    <span class="n">data_dict</span><span class="p">[</span><span class="s">&#39;process&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;add&#39;</span>
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;model&#39;</span><span class="p">:</span> <span class="n">ckan_model</span><span class="p">,</span> <span class="s">&#39;session&#39;</span><span class="p">:</span> <span class="n">ckan_model</span><span class="o">.</span><span class="n">Session</span><span class="p">}</span>

    <span class="k">for</span> <span class="n">index_dict</span> <span class="ow">in</span> <span class="n">resource_dict_list</span><span class="p">:</span>
        <span class="n">index_dict</span><span class="p">[</span><span class="s">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;NEW&#39;</span>
        <span class="n">data_dict</span><span class="p">[</span><span class="s">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">index_dict</span>
        <span class="n">trans_dispatch</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">data_dict</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">True</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-66'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-66'>#</a>
      </div>
      <p>Finds and returns all the documents to be indexed records from 'resource_document_index' table based on the input status.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">get_docs_to_index</span><span class="p">(</span><span class="n">status</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-67'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-67'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">query</span> <span class="o">=</span> <span class="n">ckan_model</span><span class="o">.</span><span class="n">DocumentIndex</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-68'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-68'>#</a>
      </div>
      <p>This is the initial step to Full Text Indexing process. Will get all the documents to be indexed with status "NEW' and
for each document's content will be extracted and updated to Dataset's solr indexing.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">process_resource_docs_to_index</span><span class="p">():</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-69'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-69'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">docs_to_index</span> <span class="o">=</span> <span class="n">get_docs_to_index</span><span class="p">(</span><span class="s">&#39;NEW&#39;</span><span class="p">)</span>

    <span class="kn">from</span> <span class="nn">ckanext.ngds.indexer.index</span> <span class="kn">import</span> <span class="n">FullTextIndexer</span>

    <span class="n">text_indexer</span> <span class="o">=</span> <span class="n">FullTextIndexer</span><span class="p">()</span>
    <span class="n">site_id</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;ckan.site_id&#39;</span><span class="p">,</span> <span class="s">&#39;default&#39;</span><span class="p">)</span>
    <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;site_id&#39;</span><span class="p">:</span> <span class="n">site_id</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">docs_to_index</span><span class="p">:</span>
        <span class="n">data_dict</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">package_id</span>
        <span class="n">field_to_add</span> <span class="o">=</span> <span class="s">&#39;resource_file_</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">doc</span><span class="o">.</span><span class="n">resource_id</span>
        <span class="n">text_indexer</span><span class="o">.</span><span class="n">index_resource_file</span><span class="p">(</span><span class="n">data_dict</span><span class="p">,</span> <span class="n">field_to_add</span><span class="p">,</span> <span class="n">doc</span><span class="o">.</span><span class="n">file_path</span><span class="p">,</span> <span class="n">defer_commit</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">doc</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s">&#39;DONE&#39;</span>
        <span class="n">doc</span><span class="o">.</span><span class="n">save</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-70'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-70'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">get_master_style</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;ngds.is_development&#39;</span><span class="p">,</span> <span class="s">&quot;false&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;true&quot;</span><span class="p">:</span>
        <span class="n">less_file</span> <span class="o">=</span> <span class="s">&#39;&lt;link rel=&quot;stylesheet/less&quot; type=&quot;text/css&quot; href=&quot;/css/main.less&quot;/&gt;&#39;</span>
        <span class="n">less_js</span> <span class="o">=</span> <span class="s">&#39; &lt;script type=&quot;text/javascript&quot; src=&quot;/vendor/less/less.min.js&quot;&gt;&lt;/script&gt;&#39;</span>
        <span class="k">return</span> <span class="n">literal</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">less_file</span><span class="p">,</span> <span class="n">less_js</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">literal</span><span class="p">(</span><span class="s">&#39;&lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;/css/main.css&quot;/&gt;&#39;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-71'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-71'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">split</span><span class="p">(</span><span class="n">what</span><span class="p">,</span> <span class="n">how</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">how</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">what</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-72'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-72'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">get_label_for_pkg_attribute</span><span class="p">(</span><span class="n">attribute</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">attribute</span> <span class="ow">in</span> <span class="n">label_attribute_mapping</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">label_attribute_mapping</span><span class="p">[</span><span class="n">attribute</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">attribute</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-73'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-73'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">get_label_for_resource_attribute</span><span class="p">(</span><span class="n">attribute</span><span class="p">):</span>
    <span class="n">s_attribute</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">attribute</span><span class="p">)</span>
    <span class="k">print</span> <span class="n">s_attribute</span>
    <span class="k">if</span> <span class="n">s_attribute</span> <span class="ow">in</span> <span class="n">res_label_attribute_mapping</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">res_label_attribute_mapping</span><span class="p">[</span><span class="n">s_attribute</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">s_attribute</span>


<span class="n">label_attribute_mapping</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">u&#39;data_type&#39;</span><span class="p">:</span> <span class="s">u&#39;Data Type&#39;</span><span class="p">,</span>
    <span class="s">u&#39;language&#39;</span><span class="p">:</span> <span class="s">u&#39;Language&#39;</span><span class="p">,</span>
    <span class="s">u&#39;lineage&#39;</span><span class="p">:</span> <span class="s">u&#39;Lineage&#39;</span><span class="p">,</span>
    <span class="s">u&#39;ngds_maintainer&#39;</span><span class="p">:</span> <span class="s">u&#39;Maintainers&#39;</span><span class="p">,</span>
    <span class="s">u&#39;publication_date&#39;</span><span class="p">:</span> <span class="s">u&#39;Publication Date&#39;</span><span class="p">,</span>
    <span class="s">u&#39;quality&#39;</span><span class="p">:</span> <span class="s">u&#39;Quality&#39;</span><span class="p">,</span>
    <span class="s">u&#39;spatial&#39;</span><span class="p">:</span> <span class="s">u&#39;Geographic Location&#39;</span><span class="p">,</span>
    <span class="s">u&#39;spatial_word&#39;</span><span class="p">:</span> <span class="s">u&#39;Geographic Location Tags&#39;</span><span class="p">,</span>
    <span class="s">u&#39;status&#39;</span><span class="p">:</span> <span class="s">u&#39;Status&#39;</span><span class="p">,</span>
    <span class="s">u&#39;uri&#39;</span><span class="p">:</span> <span class="s">u&#39;URI&#39;</span><span class="p">,</span>
    <span class="s">u&#39;authors&#39;</span><span class="p">:</span> <span class="s">u&#39;Authors&#39;</span>
<span class="p">}</span>

<span class="n">res_label_attribute_mapping</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;dataset name&#39;</span><span class="p">:</span> <span class="s">&#39;Dataset Name&#39;</span><span class="p">,</span>
    <span class="s">&#39;distributor&#39;</span><span class="p">:</span> <span class="s">&#39;Distributor&#39;</span><span class="p">,</span>
    <span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="s">&#39;Id&#39;</span><span class="p">,</span>
    <span class="s">&#39;layer&#39;</span><span class="p">:</span> <span class="s">&#39;Layer&#39;</span><span class="p">,</span>
    <span class="s">&#39;position&#39;</span><span class="p">:</span> <span class="s">&#39;Position&#39;</span><span class="p">,</span>
    <span class="s">&#39;protocol&#39;</span><span class="p">:</span> <span class="s">&#39;Protocol&#39;</span><span class="p">,</span>
    <span class="s">&#39;resource format&#39;</span><span class="p">:</span> <span class="s">&#39;Resource Type&#39;</span><span class="p">,</span>
    <span class="s">&#39;resource group id&#39;</span><span class="p">:</span> <span class="s">&#39;Resource Group Id&#39;</span><span class="p">,</span>
    <span class="s">&#39;revision id&#39;</span><span class="p">:</span> <span class="s">&#39;Revision Id&#39;</span><span class="p">,</span>
    <span class="s">&#39;revision timestamp&#39;</span><span class="p">:</span> <span class="s">&#39;Revision Timestamp&#39;</span><span class="p">,</span>
    <span class="s">&#39;state&#39;</span><span class="p">:</span> <span class="s">&#39;State&#39;</span><span class="p">,</span>
    <span class="s">&#39;content model uri&#39;</span><span class="p">:</span> <span class="s">&#39;Content Model URI&#39;</span><span class="p">,</span>
    <span class="s">&#39;format&#39;</span><span class="p">:</span> <span class="s">&#39;Format&#39;</span><span class="p">,</span>
    <span class="s">&#39;geoserver layer name&#39;</span><span class="p">:</span> <span class="s">&#39;Geoserver Layer&#39;</span><span class="p">,</span>
    <span class="s">&#39;geom extent&#39;</span><span class="p">:</span> <span class="s">&#39;Geographic Extent&#39;</span><span class="p">,</span>
    <span class="s">&#39;layer name&#39;</span><span class="p">:</span> <span class="s">&#39;Geoserver Layer Name&#39;</span><span class="p">,</span>
    <span class="s">&#39;parent resource&#39;</span><span class="p">:</span> <span class="s">&#39;Parent Resource Id&#39;</span>
<span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-74'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-74'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">is_json</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">except</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="bp">False</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-75'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-75'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">is_development</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;ngds.is_development&#39;</span><span class="p">,</span> <span class="s">&quot;false&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;true&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">return</span> <span class="bp">False</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-76'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-76'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">get_top_5_harvest_sources</span><span class="p">():</span>
    <span class="n">sources</span> <span class="o">=</span> <span class="n">logic</span><span class="o">.</span><span class="n">get_action</span><span class="p">(</span><span class="s">&#39;harvest_source_list&#39;</span><span class="p">)(</span><span class="bp">None</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">top_sources</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s">&#39;status&#39;</span><span class="p">][</span><span class="s">&#39;overall_statistics&#39;</span><span class="p">][</span><span class="s">&#39;added&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">top_sources</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-77'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-77'>#</a>
      </div>
      <p>Reads the home images configuration file and return the home images and their hyperlinks as dictionary.
If the configuration is already loaded the return from global context otherwise read the config file and load
images values.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">get_home_images</span><span class="p">():</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-78'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-78'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">home_image_items</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Home images are already loaded.&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Home images are yet to be loaded. Loading from configuration.&quot;</span><span class="p">)</span>

        <span class="n">ngds_home_image_config_path</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;ngds.home_images_config_path&#39;</span><span class="p">)</span>

        <span class="kn">import</span> <span class="nn">ConfigParser</span>
        <span class="kn">import</span> <span class="nn">os</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">ngds_home_image_config_path</span><span class="p">):</span>
            <span class="n">cfgparser</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="o">.</span><span class="n">SafeConfigParser</span><span class="p">()</span>
            <span class="n">cfgparser</span><span class="o">.</span><span class="n">readfp</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">ngds_home_image_config_path</span><span class="p">))</span>
            <span class="n">section</span> <span class="o">=</span> <span class="s">&#39;ngds:images&#39;</span>
            <span class="k">if</span> <span class="n">cfgparser</span><span class="o">.</span><span class="n">has_section</span><span class="p">(</span><span class="n">section</span><span class="p">):</span>
                <span class="n">image_items</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">cfgparser</span><span class="o">.</span><span class="n">items</span><span class="p">(</span><span class="n">section</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">image_items</span><span class="p">:</span>
                <span class="n">image_direcotry</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;ngds.home_images_dir&#39;</span><span class="p">,</span> <span class="s">&#39;assets&#39;</span><span class="p">)</span>

                <span class="n">prepend_str</span> <span class="o">=</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">image_direcotry</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-79'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-79'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="n">multilevelDict</span><span class="p">):</span>
                    <span class="k">return</span> <span class="nb">dict</span><span class="p">((</span><span class="n">prepend_str</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="p">(</span><span class="n">transform</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="n">value</span><span class="p">))</span> <span class="k">for</span>
                                <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">multilevelDict</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

                <span class="n">g</span><span class="o">.</span><span class="n">home_image_items</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">image_items</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">home_image_items</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-80'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-80'>#</a>
      </div>
      <p>Returns the filtered fields in the search results of library page. This method will get called when CKAN doesn't
return the filtered items(inconsistency in CKAN group/organization view). Request params are checked for filter
criteria and added to the filter.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">get_filtered_items</span><span class="p">(</span><span class="n">request_params</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-81'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-81'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">fields_grouped</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">request_params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">param</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;q&#39;</span><span class="p">,</span> <span class="s">&#39;page&#39;</span><span class="p">,</span> <span class="s">&#39;sort&#39;</span><span class="p">]</span> \
                <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">param</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">param</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;ext_&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">param</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">fields_grouped</span><span class="p">:</span>
                <span class="n">fields_grouped</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fields_grouped</span><span class="p">[</span><span class="n">param</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fields_grouped</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-82'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-82'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">get_content_models</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">logic</span><span class="o">.</span><span class="n">get_action</span><span class="p">(</span><span class="s">&#39;contentmodel_list_short&#39;</span><span class="p">)()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-83'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-83'>#</a>
      </div>
      <p>Returns the contributors configured in the configuration.</p>
<p>:return:List of contributors as dictionary</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">get_contributors_list</span><span class="p">():</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-84'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-84'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">contributors_list</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Contributors list is already loaded.&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="n">contributors_config</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;ngds.contributors_config&#39;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-85'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-85'>#</a>
      </div>
      <p>Open the json config file and load it as dict.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">contributors_config</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">json</span>
            <span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>

            <span class="n">contributors_list</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>
            <span class="n">image_direcotry</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;ngds.home_images_dir&#39;</span><span class="p">,</span> <span class="s">&#39;assets&#39;</span><span class="p">)</span>

            <span class="n">prepend_str</span> <span class="o">=</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">image_direcotry</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span>

            <span class="k">for</span> <span class="n">contributor</span> <span class="ow">in</span> <span class="n">contributors_list</span><span class="p">:</span>
                <span class="n">contributor</span><span class="p">[</span><span class="s">&#39;logo_path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prepend_str</span> <span class="o">+</span> <span class="n">contributor</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;logo_path&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-86'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-86'>#</a>
      </div>
      <p>contributors_list.append(contributor)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">print</span> <span class="s">&quot;contributors_list: &quot;</span><span class="p">,</span><span class="n">contributors_list</span>

        <span class="n">g</span><span class="o">.</span><span class="n">contributors_list</span> <span class="o">=</span> <span class="n">contributors_list</span>

    <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">contributors_list</span>

</pre></div>
    </div>
  </div>
  <div class='clearall'></div>
</div>
</body>
