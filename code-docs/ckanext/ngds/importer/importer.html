<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>importer.py</title>
  <link rel="stylesheet" href="../../../pycco.css">
</head>
<body>
<div id="background"></div>
<div id='container'>
  <div class='section'>
    <div class='docs'><h1>importer.py</h1></div>
  </div>
  <div class='clearall'>
  <div class='section' id='section-0'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-0'>#</a>
      </div>
      <p>Responsible for handling bulk-upload process. Loads the data from xls file to a dictionary and calls loader process to
create the pacakge in CKAN.</p>
<p>As part of import from xls, all the fields which has the referenced data (predefined list of values for a field) are
 validated and replaced with the valid keys expected by the system.</p>
<p>Any user related information is loaded as Json in the combination of Name and Email of the user field( Author,Maintainer
and Distributor).</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="kn">from</span> <span class="nn">sqlalchemy.util</span> <span class="kn">import</span> <span class="n">OrderedDict</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-1'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-1'>#</a>
      </div>
      <p>import ckan.model as model</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="kn">from</span> <span class="nn">ckan.plugins</span> <span class="kn">import</span> <span class="n">toolkit</span>
<span class="kn">from</span> <span class="nn">ckanext.ngds.env</span> <span class="kn">import</span> <span class="n">ckan_model</span>
<span class="kn">from</span> <span class="nn">ckanext.importlib.importer</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">ckanext.importlib.spreadsheet_importer</span> <span class="kn">as</span> <span class="nn">spreadsheet_importer</span>

<span class="kn">import</span> <span class="nn">ckanext.ngds.importer.helper</span> <span class="kn">as</span> <span class="nn">import_helper</span>
<span class="kn">from</span> <span class="nn">pylons</span> <span class="kn">import</span> <span class="n">config</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-2'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-2'>#</a>
      </div>
      <p>the following needs to be revisted and removed...</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="kn">from</span> <span class="nn">ckanext.ngds.metadata.controllers.transaction_data</span> <span class="kn">import</span> <span class="n">dispatch</span> <span class="k">as</span> <span class="n">trans_dispatch</span>
<span class="kn">from</span> <span class="nn">ckanext.ngds.ngdsui.misc</span> <span class="kn">import</span> <span class="n">helpers</span> <span class="k">as</span> <span class="n">ui_helper</span>

<span class="n">log</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="s">&quot;logging&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-3'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-3'>#</a>
      </div>
      <p>Need to decide our own Read only keys</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="n">readonly_keys</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="s">&#39;revision_id&#39;</span><span class="p">,</span>
                 <span class="s">&#39;relationships&#39;</span><span class="p">,</span>
                 <span class="s">&#39;license&#39;</span><span class="p">,</span>
                 <span class="s">&#39;ratings_average&#39;</span><span class="p">,</span> <span class="s">&#39;ratings_count&#39;</span><span class="p">,</span>
                 <span class="s">&#39;ckan_url&#39;</span><span class="p">,</span>
                 <span class="s">&#39;metadata_modified&#39;</span><span class="p">,</span>
                 <span class="s">&#39;metadata_created&#39;</span><span class="p">,</span>
                 <span class="s">&#39;notes_rendered&#39;</span><span class="p">)</span>

<span class="n">referenced_keys</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;data_type&#39;</span><span class="p">,</span> <span class="s">&#39;status&#39;</span><span class="p">,</span> <span class="s">&#39;protocol&#39;</span><span class="p">)</span>

<span class="n">responsible_party_keys</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;authors&#39;</span><span class="p">,</span> <span class="s">&#39;maintainer&#39;</span><span class="p">,</span> <span class="s">&#39;distributor&#39;</span><span class="p">)</span>

<span class="n">date_keys</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;publication_date&#39;</span><span class="p">)</span>


<span class="n">DEFAULT_GROUP</span> <span class="o">=</span> <span class="n">ui_helper</span><span class="o">.</span><span class="n">get_default_group</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-4'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-4'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">BulkUploader</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-5'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-5'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">client_config</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">client_config</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">client_config_file</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;ngds.client_config_file&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">client_config_file</span> <span class="o">=</span> <span class="n">client_config</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-6'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-6'>#</a>
      </div>
      <p>print "client_config_file: ",client_config_file</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">_loadclientconfig</span><span class="p">(</span><span class="n">client_config_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ckanclient</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_ckanclient</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-7'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-7'>#</a>
      </div>
      <p>Loads the client config file which contains the details about server and api key for accessing the server
functions.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_loadclientconfig</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">config_path</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-8'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-8'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="kn">import</span> <span class="nn">ConfigParser</span>
        <span class="kn">import</span> <span class="nn">os</span>
        <span class="kn">import</span> <span class="nn">urlparse</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">config_path</span><span class="p">):</span>
            <span class="n">cfgparser</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="o">.</span><span class="n">SafeConfigParser</span><span class="p">()</span>
            <span class="n">cfgparser</span><span class="o">.</span><span class="n">readfp</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">config_path</span><span class="p">))</span>
            <span class="n">section</span> <span class="o">=</span> <span class="s">&#39;app:client&#39;</span>
            <span class="k">if</span> <span class="n">cfgparser</span><span class="o">.</span><span class="n">has_section</span><span class="p">(</span><span class="n">section</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">cfgparser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s">&#39;api_url&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-9'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-9'>#</a>
      </div>
      <p>print "self.url: ",self.url</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">==</span><span class="s">&#39;&#39;</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-10'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-10'>#</a>
      </div>
      <p>print "API URL is None so can't proceed further"</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">toolkit</span><span class="o">.</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Unable to find API URL or URL is empty&quot;</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parsed</span> <span class="o">=</span> <span class="n">urlparse</span><span class="o">.</span><span class="n">urlparse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
                <span class="n">newparsed</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parsed</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">netloc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parsed</span><span class="o">.</span><span class="n">netloc</span>            
                <span class="n">section</span> <span class="o">=</span> <span class="s">&#39;index:</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">netloc</span>
                <span class="k">if</span> <span class="n">cfgparser</span><span class="o">.</span><span class="n">has_section</span><span class="p">(</span><span class="n">section</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">cfgparser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s">&#39;api_key&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>                
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span> <span class="o">==</span><span class="s">&#39;&#39;</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-11'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-11'>#</a>
      </div>
      <p>print "API URL is None so can't proceed further"</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">toolkit</span><span class="o">.</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Unable to find API key or API key is empty.&quot;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>                        
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">toolkit</span><span class="o">.</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Unable to find API URL or URL is empty&quot;</span><span class="p">))</span>

        <span class="k">else</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-12'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-12'>#</a>
      </div>
      <p>print "Unable to find the client configuration file."</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">toolkit</span><span class="o">.</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Unable to find the client config file.&quot;</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-13'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-13'>#</a>
      </div>
      <p>Returns NGDS Ckan client.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_get_ckanclient</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-14'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-14'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="kn">from</span> <span class="nn">ckanext.ngds.lib.client</span> <span class="kn">import</span> <span class="n">NgdsCkanClient</span>

        <span class="n">testclient</span> <span class="o">=</span> <span class="n">NgdsCkanClient</span><span class="p">(</span><span class="n">base_location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">api_key</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">testclient</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-15'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-15'>#</a>
      </div>
      <p>This method will get all the bulk uploaded records with the status of "VALID" and process them. 
If it can process the records successfully then updates the status as "Completed" otherwise as "Failure" and corresponding comments.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">execute_bulk_upload</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-16'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-16'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="kn">import</span> <span class="nn">os</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;entering execute_bulk_upload&quot;</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">ckan_model</span><span class="o">.</span><span class="n">BulkUpload</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&quot;VALID&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">bulk_upload_record</span> <span class="ow">in</span> <span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>

            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Processing the file: </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bulk_upload_record</span><span class="o">.</span><span class="n">data_file</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">data_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bulk_upload_record</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="n">bulk_upload_record</span><span class="o">.</span><span class="n">data_file</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">importpackagedata</span><span class="p">(</span><span class="n">bulk_upload_record</span><span class="o">.</span><span class="n">id</span><span class="p">,</span><span class="n">file_path</span><span class="o">=</span><span class="n">data_file_path</span><span class="p">,</span><span class="n">resource_dir</span><span class="o">=</span><span class="n">bulk_upload_record</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="n">ckanclient</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ckanclient</span><span class="p">)</span>
                <span class="n">bulk_upload_record</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s">&quot;COMPLETED&quot;</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Exception while processing bulk upload for the file : </span><span class="si">%s</span><span class="s">&quot;</span> <span class="p">,</span> <span class="n">bulk_upload_record</span><span class="o">.</span><span class="n">data_file</span> <span class="p">)</span>
                <span class="n">bulk_upload_record</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s">&quot;FAILURE&quot;</span>
                <span class="n">bulk_upload_record</span><span class="o">.</span><span class="n">comments</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">message</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">import_helper</span><span class="o">.</span><span class="n">delete_files</span><span class="p">(</span><span class="n">file_path</span><span class="o">=</span><span class="n">bulk_upload_record</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="n">ignore_files</span><span class="o">=</span><span class="p">[</span><span class="n">bulk_upload_record</span><span class="o">.</span><span class="n">data_file</span><span class="p">,</span><span class="n">bulk_upload_record</span><span class="o">.</span><span class="n">resources</span><span class="p">])</span>
                <span class="n">bulk_upload_record</span><span class="o">.</span><span class="n">last_updated</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="n">bulk_upload_record</span><span class="o">.</span><span class="n">save</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-17'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-17'>#</a>
      </div>
      <p>This is an entry point for bulk upload of one record(bulk uploaded template). Loads the package details as
dict from xls file and loads them into CKAN. Each successfully loaded pacakges are referenced against bulk upload
record for tracking.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">importpackagedata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">bulk_upload_id</span><span class="p">,</span><span class="n">file_path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">resource_dir</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">ckanclient</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-18'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-18'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="kn">from</span> <span class="nn">ckan.lib.navl.dictization_functions</span> <span class="kn">import</span> <span class="n">unflatten</span>
        <span class="kn">from</span> <span class="nn">ckan.logic</span> <span class="kn">import</span> <span class="p">(</span><span class="n">tuplize_dict</span><span class="p">,</span><span class="n">clean_dict</span>  <span class="p">)</span>

        
        <span class="kn">from</span> <span class="nn">ckanext.ngds.importer.loader</span> <span class="kn">import</span> <span class="n">ResourceLoader</span>

        <span class="k">if</span> <span class="n">ckanclient</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">ckanclient</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_ckanclient</span><span class="p">()</span>

        <span class="n">loader</span> <span class="o">=</span> <span class="n">ResourceLoader</span><span class="p">(</span><span class="n">ckanclient</span><span class="p">,</span><span class="n">field_keys_to_find_pkg_by</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">],</span><span class="n">resource_dir</span><span class="o">=</span><span class="n">resource_dir</span><span class="p">)</span>
          
        <span class="n">package_import</span> <span class="o">=</span> <span class="n">NGDSPackageImporter</span><span class="p">(</span><span class="n">filepath</span><span class="o">=</span><span class="n">file_path</span><span class="p">)</span>

        <span class="n">pkg_dicts</span> <span class="o">=</span> <span class="p">[</span><span class="n">pkg_dict</span> <span class="k">for</span> <span class="n">pkg_dict</span> <span class="ow">in</span> <span class="n">package_import</span><span class="o">.</span><span class="n">pkg_dict</span><span class="p">()]</span>

        <span class="k">for</span> <span class="n">pkg_dict</span> <span class="ow">in</span> <span class="n">pkg_dicts</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">returned_package</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">load_package</span><span class="p">(</span><span class="n">clean_dict</span><span class="p">(</span><span class="n">unflatten</span><span class="p">(</span><span class="n">tuplize_dict</span><span class="p">(</span><span class="n">pkg_dict</span><span class="p">))))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-19'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-19'>#</a>
      </div>
      <p>Upload bulk upload to package relationship.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="bp">self</span><span class="o">.</span><span class="n">_create_bulk_upload_package</span><span class="p">(</span><span class="n">bulk_upload_id</span><span class="p">,</span><span class="n">returned_package</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">],</span><span class="n">returned_package</span><span class="p">[</span><span class="s">&#39;title&#39;</span><span class="p">])</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Skipping this record and proceeding with next one....&quot;</span><span class="p">)</span>
                <span class="k">raise</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-20'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-20'>#</a>
      </div>
      <p>Creates DB entry in 'bulk_upload_package' table for linking bulk upload and uploaded package.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_create_bulk_upload_package</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">bulk_upload_id</span><span class="p">,</span> <span class="n">package_name</span><span class="p">,</span> <span class="n">package_title</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-21'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-21'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Create Bulk Upload Package: bid: </span><span class="si">%s</span><span class="s"> pname: </span><span class="si">%s</span><span class="s">  ptitle: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">bulk_upload_id</span><span class="p">,</span> <span class="n">package_name</span><span class="p">,</span> <span class="n">package_title</span><span class="p">))</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;bulk_upload_id&#39;</span><span class="p">:</span> <span class="n">bulk_upload_id</span><span class="p">,</span> <span class="s">&#39;package_name&#39;</span><span class="p">:</span> <span class="n">package_name</span><span class="p">,</span> <span class="s">&#39;package_title&#39;</span><span class="p">:</span> <span class="n">package_title</span><span class="p">}</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;model&#39;</span><span class="p">:</span> <span class="s">&#39;BulkUpload_Package&#39;</span><span class="p">}</span>
        <span class="n">data_dict</span><span class="p">[</span><span class="s">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
        <span class="n">data_dict</span><span class="p">[</span><span class="s">&#39;process&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;create&#39;</span>
        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;model&#39;</span><span class="p">:</span> <span class="n">ckan_model</span><span class="p">,</span> <span class="s">&#39;session&#39;</span><span class="p">:</span> <span class="n">ckan_model</span><span class="o">.</span><span class="n">Session</span><span class="p">}</span>
        <span class="n">trans_dispatch</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">data_dict</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-22'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-22'>#</a>
      </div>
      <p>Takes SpreadsheetData and converts it its titles and</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">SpreadsheetDataRecords</span><span class="p">(</span><span class="n">DataRecords</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-23'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-23'>#</a>
      </div>
      <p>data records. Handles title rows and filters out rows of rubbish.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spreadsheet_data</span><span class="p">,</span> <span class="n">essential_title</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spreadsheet_data</span><span class="p">,</span> <span class="n">spreadsheet_importer</span><span class="o">.</span><span class="n">SpreadsheetData</span><span class="p">),</span> <span class="n">spreadsheet_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">spreadsheet_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">titles</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_titles_row_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_titles</span><span class="p">(</span><span class="n">essential_title</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_first_record_row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_first_record_row</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_titles_row_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-24'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-24'>#</a>
      </div>
      <p>Finds the title row based on mandatory title field.These title values are the actual keys of the metadata.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">find_titles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">essential_title</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-25'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-25'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">row_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">titles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">essential_title_lower</span> <span class="o">=</span> <span class="n">essential_title</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">row_index</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_num_rows</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">ImportException</span><span class="p">(</span><span class="n">toolkit</span><span class="o">.</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;Could not find title row&#39;</span><span class="p">))</span>
            <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_row</span><span class="p">(</span><span class="n">row_index</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">essential_title</span> <span class="ow">in</span> <span class="n">row</span> <span class="ow">or</span> <span class="n">essential_title_lower</span> <span class="ow">in</span> <span class="n">row</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">row_val</span> <span class="ow">in</span> <span class="n">row</span><span class="p">:</span>
                    <span class="n">titles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row_val</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">row_val</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="k">else</span> <span class="bp">None</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">titles</span><span class="p">,</span> <span class="n">row_index</span><span class="p">)</span>
            <span class="n">row_index</span> <span class="o">+=</span> <span class="mi">1</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-26'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-26'>#</a>
      </div>
      <p>Finds the first record row based on the title row index.If no records found then raises exception.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">find_first_record_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row_index_to_start_looking</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-27'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-27'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">row_index</span> <span class="o">=</span> <span class="n">row_index_to_start_looking</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">row_index</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_num_rows</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">ImportException</span><span class="p">(</span><span class="n">toolkit</span><span class="o">.</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;Could not find first record row&#39;</span><span class="p">))</span>
            <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_row</span><span class="p">(</span><span class="n">row_index</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="s">u&#39;&lt;&lt; Datasets Displayed Below&#39;</span> <span class="ow">in</span> <span class="n">row</span> <span class="ow">or</span>\
                    <span class="n">row</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">]</span> <span class="ow">or</span>\
                    <span class="n">row</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">]</span>\
                    <span class="p">):</span>
                <span class="k">return</span> <span class="n">row_index</span>
            <span class="n">row_index</span> <span class="o">+=</span> <span class="mi">1</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-28'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-28'>#</a>
      </div>
      <p>Returns each record as a dict.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">records</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-29'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-29'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">for</span> <span class="n">row_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_first_record_row</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_num_rows</span><span class="p">()):</span>
            <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_row</span><span class="p">(</span><span class="n">row_index</span><span class="p">)</span>
            <span class="n">row_has_content</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">row</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cell</span><span class="p">:</span>
                    <span class="n">row_has_content</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">row_has_content</span><span class="p">:</span>
                <span class="n">record_dict</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">titles</span><span class="p">,</span> <span class="n">row</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">record_dict</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="bp">None</span><span class="p">):</span>
                    <span class="k">del</span> <span class="n">record_dict</span><span class="p">[</span><span class="bp">None</span><span class="p">]</span>
                <span class="k">yield</span> <span class="n">record_dict</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-30'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-30'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">NGDSPackageImporter</span><span class="p">(</span><span class="n">spreadsheet_importer</span><span class="o">.</span><span class="n">SpreadsheetPackageImporter</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;From a filepath of an Excel or csv file, extracts package</span>
<span class="sd">    dictionaries.&#39;&#39;&#39;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-31'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-31'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record_params</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">record_class</span><span class="o">=</span><span class="n">SpreadsheetDataRecords</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_record_params</span> <span class="o">=</span> <span class="n">record_params</span> <span class="k">if</span> <span class="n">record_params</span> <span class="o">!=</span> <span class="bp">None</span> <span class="k">else</span> <span class="p">[</span><span class="s">&#39;Title&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_record_class</span> <span class="o">=</span> <span class="n">record_class</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">NGDSPackageImporter</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">record_class</span><span class="o">=</span><span class="n">record_class</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-32'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-32'>#</a>
      </div>
      <p>Gets the license ID based on the license description value. If doesn't exist then return empty.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">license_2_license_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">license_title</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-33'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-33'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-34'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-34'>#</a>
      </div>
      <p>import is here, as it creates a dependency on ckan, which many importers won't want</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="kn">from</span> <span class="nn">ckan.model.license</span> <span class="kn">import</span> <span class="n">LicenseRegister</span>
        <span class="n">licenses</span> <span class="o">=</span> <span class="n">LicenseRegister</span><span class="p">()</span>
        <span class="n">license_obj</span> <span class="o">=</span> <span class="n">licenses</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">license_title</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">license_obj</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">u&#39;</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">license_obj</span><span class="o">.</span><span class="n">id</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&#39;Warning: No license name matches </span><span class="si">%s</span><span class="s">. Ignoring license.&#39;</span> <span class="o">%</span> <span class="n">license_title</span><span class="p">)</span>
            <span class="k">return</span> <span class="s">u&#39;&#39;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-35'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-35'>#</a>
      </div>
      <p>TODO: Need to remove this function.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">responsible_party_2_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">email</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-36'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-36'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">resparty</span> <span class="o">=</span> <span class="n">ckan_model</span><span class="o">.</span><span class="n">ResponsibleParty</span><span class="p">()</span>

        <span class="n">foundparties</span> <span class="o">=</span> <span class="p">(</span><span class="n">resparty</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">email</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="n">numberofResParties</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">foundparties</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">numberofResParties</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">toolkit</span><span class="o">.</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Data Error: No responsible party is found with the given name </span><span class="si">%s</span><span class="s"> and email </span><span class="si">%s</span><span class="s"> &quot;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">email</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-37'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-37'>#</a>
      </div>
      <p>Need to add this person into Responsible Party details.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">elif</span> <span class="n">numberofResParties</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">toolkit</span><span class="o">.</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Data Error: More than one responsible party is found with the given name </span><span class="si">%s</span><span class="s"> and email </span><span class="si">%s</span><span class="s"> &quot;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">email</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Found Party ID: </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span><span class="n">numberofResParties</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">numberofResParties</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-38'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-38'>#</a>
      </div>
      <p>Validates whether any referenced data field exists in the Standing Data (Reference base table) table. If not
raises Exception.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">validate_SD</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">model_type</span><span class="p">,</span><span class="n">sdValue</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-39'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-39'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-40'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-40'>#</a>
      </div>
      <p>Call Model's validate method which will compare the sd value against the Standing data table.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">sdObject</span> <span class="o">=</span> <span class="n">ckan_model</span><span class="o">.</span><span class="n">StandingData</span><span class="p">()</span>

        <span class="n">validated_value</span> <span class="o">=</span> <span class="n">sdObject</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">model_type</span><span class="p">,</span> <span class="n">sdValue</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">validated_value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">toolkit</span><span class="o">.</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Data Error: No Standing data matching the input - </span><span class="si">%s</span><span class="s"> for the type - </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">sdValue</span><span class="p">,</span><span class="n">model_type</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">validated_value</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-41'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-41'>#</a>
      </div>
      <p>Validates whether the input responsible party details already exists in the system.(Authors, maintainer and
distributor are considered as Responsible Parties). Authors is a multi-valued field, hence separated by comma.
If doesn't exist then raises validation Exception, otherwise returns the responsible party details as Json.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">validate_responsible_party</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">email_string</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-42'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-42'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="kn">from</span> <span class="nn">ckanext.ngds.env</span> <span class="kn">import</span> <span class="n">ckan_model</span>

        <span class="n">email_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">email_string</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">email_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">field_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s">&#39;authors&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">toolkit</span><span class="o">.</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Data Error: </span><span class="si">%s</span><span class="s"> can not have more than one person&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">field_name</span><span class="p">)</span>

        <span class="n">party_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">email</span> <span class="ow">in</span> <span class="n">email_list</span><span class="p">:</span>

            <span class="n">returned_party</span> <span class="o">=</span> <span class="n">ckan_model</span><span class="o">.</span><span class="n">ResponsibleParty</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">email</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">returned_party</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">returned_party</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">user_dict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">user_dict</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">returned_party</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
                <span class="n">user_dict</span><span class="p">[</span><span class="s">&#39;email&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">returned_party</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">email</span>
                <span class="n">party_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user_dict</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">toolkit</span><span class="o">.</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Responsible party with email: </span><span class="si">%s</span><span class="s"> not found in the system. Please add either manually or use loader script.&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">email</span><span class="p">)</span>

        <span class="kn">import</span> <span class="nn">json</span>
        <span class="k">if</span> <span class="n">field_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;authors&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">party_list</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">party_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-43'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-43'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_iso_date_string</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">cell</span><span class="p">):</span>

        <span class="k">return</span> <span class="bp">None</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">pkg_xl_dict_to_fs_dict</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">pkg_xl_dict</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Convert a Package represented in an Excel-type dictionary to a</span>
<span class="sd">        dictionary suitable for fieldset data.</span>
<span class="sd">        Takes Excel-type dict:</span>
<span class="sd">            {&#39;name&#39;:&#39;wikipedia&#39;, </span>
<span class="sd">             &#39;resource-0-url&#39;:&#39;http://static.wikipedia.org/&#39;}</span>
<span class="sd">        Returns Fieldset-type dict:</span>
<span class="sd">            {&#39;name&#39;:&#39;wikipedia&#39;,</span>
<span class="sd">             &#39;resources&#39;:[{&#39;url&#39;:&#39;http://static.wikipedia.org/&#39;}]}</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">standard_fields</span> <span class="o">=</span> <span class="n">ckan_model</span><span class="o">.</span><span class="n">Package</span><span class="o">.</span><span class="n">get_fields</span><span class="p">()</span>

        <span class="n">pkg_fs_dict</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">title</span><span class="p">,</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">pkg_xl_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-44'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-44'>#</a>
      </div>
      <p>log.debug("title:%s, value: %s" % (title,cell))</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">if</span> <span class="n">cell</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">title</span> <span class="ow">in</span> <span class="n">referenced_keys</span><span class="p">:</span>
                    <span class="n">cell</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">validate_SD</span><span class="p">(</span><span class="n">title</span><span class="p">,</span><span class="n">cell</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">title</span> <span class="ow">in</span> <span class="n">responsible_party_keys</span><span class="p">:</span>
                    <span class="n">cell</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">validate_responsible_party</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">cell</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">title</span> <span class="ow">in</span> <span class="n">date_keys</span><span class="p">:</span>
                    <span class="n">cell</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">get_iso_date_string</span><span class="p">(</span><span class="n">title</span><span class="p">,</span><span class="n">cell</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">title</span> <span class="o">==</span> <span class="s">&#39;tags&#39;</span><span class="p">:</span>
                    <span class="n">pkg_fs_dict</span><span class="p">[</span><span class="s">&#39;tag_string&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell</span>
                <span class="k">elif</span> <span class="n">title</span> <span class="ow">in</span> <span class="n">standard_fields</span><span class="p">:</span>
                    <span class="n">pkg_fs_dict</span><span class="p">[</span><span class="n">title</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell</span>
                <span class="k">elif</span> <span class="n">title</span> <span class="o">==</span> <span class="s">&#39;license&#39;</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-45'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-45'>#</a>
      </div>
      <p>print "license: ", cell</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                    <span class="n">license_id</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">license_2_license_id</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-46'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-46'>#</a>
      </div>
      <p>print "license_id: ",license_id</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                    <span class="k">if</span> <span class="n">license_id</span><span class="p">:</span>
                        <span class="n">pkg_fs_dict</span><span class="p">[</span><span class="s">&#39;license_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">license_id</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="p">(</span><span class="s">&#39;Warning: No license name matches </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s">. Ignoring license.&#39;</span> <span class="o">%</span> <span class="n">cell</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">title</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;resource-&#39;</span><span class="p">):</span>
                    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&#39;resource-(\d+)-(\w+)&#39;</span><span class="p">,</span> <span class="n">title</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                        <span class="n">res_index</span><span class="p">,</span> <span class="n">field</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
                        <span class="n">res_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">res_index</span><span class="p">)</span>
                        <span class="n">field</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">referenced_keys</span><span class="p">:</span>
                            <span class="n">cell</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">validate_SD</span><span class="p">(</span><span class="n">field</span><span class="p">,</span><span class="n">cell</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">responsible_party_keys</span><span class="p">:</span>
                            <span class="n">cell</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">validate_responsible_party</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">cell</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">pkg_fs_dict</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;resources&#39;</span><span class="p">):</span>
                            <span class="n">pkg_fs_dict</span><span class="p">[</span><span class="s">&#39;resources&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">resources</span> <span class="o">=</span> <span class="n">pkg_fs_dict</span><span class="p">[</span><span class="s">&#39;resources&#39;</span><span class="p">]</span>
                        <span class="n">num_new_resources</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">res_index</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">resources</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_new_resources</span><span class="p">):</span>
                            <span class="n">blank_dict</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
                            <span class="k">for</span> <span class="n">blank_field</span> <span class="ow">in</span> <span class="n">ckan_model</span><span class="o">.</span><span class="n">Resource</span><span class="o">.</span><span class="n">get_columns</span><span class="p">(</span><span class="n">extra_columns</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
                                <span class="n">blank_dict</span><span class="p">[</span><span class="n">blank_field</span><span class="p">]</span> <span class="o">=</span> <span class="s">u&#39;&#39;</span>
                            <span class="n">pkg_fs_dict</span><span class="p">[</span><span class="s">&#39;resources&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">blank_dict</span><span class="p">)</span>

                        <span class="n">pkg_fs_dict</span><span class="p">[</span><span class="s">&#39;resources&#39;</span><span class="p">][</span><span class="n">res_index</span><span class="p">][</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="p">(</span><span class="s">&#39;Warning: Could not understand resource title </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s">. Ignoring value: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">cell</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">title</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;relationships&#39;</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-47'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-47'>#</a>
      </div>
      <p>TODO</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                    <span class="k">pass</span>
                <span class="k">elif</span> <span class="n">title</span> <span class="o">==</span> <span class="s">&#39;download_url&#39;</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-48'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-48'>#</a>
      </div>
      <p>deprecated - only in there for compatibility</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                    <span class="k">pass</span>
                <span class="k">elif</span> <span class="n">title</span> <span class="ow">in</span> <span class="n">readonly_keys</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">pkg_fs_dict</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;extras&#39;</span><span class="p">):</span>
                        <span class="n">pkg_fs_dict</span><span class="p">[</span><span class="s">&#39;extras&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">pkg_fs_dict</span><span class="p">[</span><span class="s">&#39;extras&#39;</span><span class="p">][</span><span class="n">title</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell</span>
        <span class="n">pkg_fs_dict</span><span class="p">[</span><span class="s">&#39;owner_org&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">DEFAULT_GROUP</span>
        <span class="k">return</span> <span class="n">pkg_fs_dict</span>

</pre></div>
    </div>
  </div>
  <div class='clearall'></div>
</div>
</body>
